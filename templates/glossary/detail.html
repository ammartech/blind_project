{% extends 'base.html' %}
{% block title %}{{ term.term }} | Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª{% endblock %}

{% block content %}
<div class="page-head">
  <h1>{{ term.term }}</h1>
  {% if term.pronunciation_hint %}
    <p class="muted">ØªÙ„Ù…ÙŠØ­ Ù†Ø·Ù‚: <strong>{{ term.pronunciation_hint }}</strong></p>
  {% endif %}
</div>

<div class="card">
  <h2>Ø§Ù„ØªØ¹Ø±ÙŠÙ</h2>

  <p class="para">
    {{ term.definition|linebreaksbr }}
  </p>

  <!-- Voice selector -->
  <div class="tts-controls">
    <span class="tts-controls-label">ğŸ”Š Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©:</span>
    <div class="voice-selector" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª">
      <label class="voice-option selected">
        <input type="radio" name="tts-voice" value="female" checked>
        <span>ğŸ‘© Ø£Ù†Ø«Ù‰</span>
      </label>
      <label class="voice-option">
        <input type="radio" name="tts-voice" value="male">
        <span>ğŸ‘¨ Ø°ÙƒØ±</span>
      </label>
    </div>
  </div>

  <!-- Glossary TTS (âœ… URL comes from Django reverse) -->
  <div class="row">
    <button class="tts-btn"
            type="button"
            data-tts-url="{% url 'service:glossary_tts' term.pk %}"
            onclick="playGlossaryTTSFromUrl(this, 'full')">
      ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙ
    </button>
  </div>

  <p class="hint">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰) Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.</p>
</div>

{% endblock %}


{% block extra_js %}

<script>
  // ---- UI: selected radio style ----
  function syncVoiceSelectedUI() {
    document.querySelectorAll('.voice-option').forEach(label => label.classList.remove('selected'));
    const checked = document.querySelector('input[name="tts-voice"]:checked');
    if (checked) checked.closest('.voice-option')?.classList.add('selected');
  }
  document.querySelectorAll('input[name="tts-voice"]').forEach(r => r.addEventListener('change', syncVoiceSelectedUI));
  syncVoiceSelectedUI();

  function getSelectedVoice() {
    const checked = document.querySelector('input[name="tts-voice"]:checked');
    return checked ? checked.value : 'female';
  }

  // âœ… Always uses the correct endpoint from Django, no hardcoded /service/ in JS
  async function playGlossaryTTSFromUrl(button, mode='full') {
    const url = button.getAttribute('data-tts-url');
    const voice = getSelectedVoice();

    if (!url) {
      alert('Ù…Ø³Ø§Ø± TTS ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (data-tts-url).');
      return;
    }

    // If your global tts.js has a helper to send & play:
    // - we call it if exists
    if (typeof window.fetchAndPlayTTS === 'function') {
      window.fetchAndPlayTTS(url, { mode, voice }, button);
      return;
    }

    // Minimal fallback if you don't have fetchAndPlayTTS:
    try {
      button.disabled = true;
      const oldText = button.textContent;
      button.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''),
        },
        body: JSON.stringify({ mode, voice }),
      });

      const raw = await res.text();

      if (!res.ok) {
        console.error('TTS HTTP Error:', res.status, raw);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª. Ø±Ø§Ø¬Ø¹ Console.');
        return;
      }

      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        console.error('Expected JSON but got:', raw);
        alert('Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ù… ÙŠÙØ±Ø¬Ø¹ JSON. Ø±Ø§Ø¬Ø¹ Console.');
        return;
      }

      if (!data.success || !data.audio_url) {
        console.error('Bad TTS response:', data);
        alert(data.error || 'ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª.');
        return;
      }

      const audio = new Audio(data.audio_url);
      await audio.play();

      // Optional: count play if you have endpoint
      // fetch("{% url 'service:glossary_tts_played' term.pk %}", { method: 'POST', headers:{'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')?.value || '')} });

      button.textContent = oldText;
    } catch (err) {
      console.error('Glossary TTS Error:', err);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.');
    } finally {
      button.disabled = false;
      // restore text if changed
      if (button.textContent.includes('Ø¬Ø§Ø±ÙŠ')) {
        button.textContent = 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙ';
      }
    }
  }
</script>

{% endblock %}
