{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}ููุตุฉ ุตูุชูุฉ ูุฏุนู ุงูููููููู{% endblock %}</title>

  <!-- IBM Plex (Arabic) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  {% block extra_css %}{% endblock %}
  <script defer src="{% static 'js/tts.js' %}"></script>
  {% block extra_js %}{% endblock %}
</head>
<body>
  <a class="skip-link" href="#main">ุชุฎุทู ุฅูู ุงููุญุชูู</a>

  <header class="site-header">
    <nav class="navbar container">
      <a class="brand" href="{% url 'core:home' %}">
        <span class="brand-dot" aria-hidden="true"></span>
        <span>ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ</span>
      </a>

      <button class="nav-toggle" aria-label="ูุชุญ ุงููุงุฆูุฉ" aria-expanded="false" data-nav-toggle>โฐ</button>

      <ul class="nav-links" data-nav>
        <li><a href="{% url 'core:home' %}">ุงูุฑุฆูุณูุฉ</a></li>
        <li><a href="{% url 'core:services' %}">ุงูุฎุฏูุงุช</a></li>
        <li><a href="{% url 'glossary:list' %}">ูุงููุณ ุงููุตุทูุญุงุช</a></li>
        <li><a href="{% url 'core:about' %}">ูู ูุญู</a></li>
        <li><a href="{% url 'core:contact' %}">ุชูุงุตู</a></li>
        {% if user.is_authenticated %}
          <li><a class="pill" href="{% url 'service:dashboard' %}">ููุญุฉ ุงูุชุญูู</a></li>
          <li>
            <form method="post" action="{% url 'accounts:logout' %}">
              {% csrf_token %}
              <button class="linklike" type="submit">ุฎุฑูุฌ</button>
            </form>
          </li>
        {% else %}
          <li><a class="pill" href="{% url 'accounts:login' %}">ุฏุฎูู</a></li>
          <li><a class="pill outline" href="{% url 'accounts:register' %}">ุชุณุฌูู</a></li>
        {% endif %}
      </ul>
    </nav>
  </header>

  {% if messages %}
    <div class="container">
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <main id="main" class="container main">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>ูู ูุญู</h3>
        <p>
          ููุตุฉ ุตูุชูุฉ ุฑูููุฉ ูุฏุนู ุฎุฏูุงุช ุงููุนูููุงุช ููููููููู ูู ุงูููุชุจุงุช ุงูุฌุงูุนูุฉ โ ุฏุฑุงุณุฉ ุชุทุจูููุฉ ุนูู ุฌุงูุนุฉ ุทูุจุฉ.
          ูุญูู ุตูุช ุงููุณุชููุฏ ุฅูู ูุตุ ุซู ูุฌูุจ ุฃุฎุตุงุฆู ุงูููุชุจุฉ ูุตููุงุ ููุนูุฏ ุงูุฑุฏ ุจุตูุช ูุงุถุญ ูููุณุชููุฏ.
        </p>
      </div>
      <div>
        <h3>ุฑูุงุจุท ุณุฑูุนุฉ</h3>
        <ul class="footer-links">
          <li><a href="{% url 'core:services' %}">ุงูุฎุฏูุงุช</a></li>
          <li><a href="{% url 'glossary:list' %}">ูุงููุณ ุงููุตุทูุญุงุช</a></li>
          <li><a href="{% url 'core:about' %}">ูู ูุญู</a></li>
          <li><a href="{% url 'core:contact' %}">ุชูุงุตู</a></li>
        </ul>
      </div>
      <div>
        <h3>ุฅุชุงุญุฉ ุงููุตูู</h3>
        <p>ููููู ุชุดุบูู ูุฑุงุกุฉ ุตูุชูุฉ ูุฃู ูุต ูู ุงูุตูุญุฉ ุนุจุฑ ุดุฑูุท ุงูุฅุชุงุญุฉ ุงูุซุงุจุช (๐) ุฃุณูู ุงูุดุงุดุฉ.</p>
      </div>
    </div>
    <div class="container footer-bottom">
      <small>ยฉ {% now "Y" %} ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ โ ุฌููุน ุงูุญููู ูุญููุธุฉ</small>
    </div>
  </footer>

  <!-- ===== Global Accessibility TTS Toolbar ===== -->
  <div id="a11y-toolbar" class="a11y-toolbar" role="region" aria-label="ุดุฑูุท ุงููุฑุงุกุฉ ุงูุตูุชูุฉ">
    <!-- Collapsed state: single FAB button -->
    <button id="a11y-fab" class="a11y-fab" type="button"
            aria-label="ูุชุญ ุฃุฏูุงุช ุงููุฑุงุกุฉ ุงูุตูุชูุฉ"
            title="ุฃุฏูุงุช ุงููุฑุงุกุฉ ุงูุตูุชูุฉ">
      ๐
    </button>

    <!-- Expanded toolbar panel -->
    <div id="a11y-panel" class="a11y-panel hidden" role="toolbar" aria-label="ุฃุฏูุงุช ุงููุฑุงุกุฉ">
      <div class="a11y-panel-row">
        <button id="a11y-read-page" class="a11y-action-btn" type="button"
                aria-label="ูุฑุงุกุฉ ูุญุชูู ุงูุตูุญุฉ">
          ๐ ูุฑุงุกุฉ ุงูุตูุญุฉ
        </button>

        <button id="a11y-stop" class="a11y-action-btn danger" type="button"
                aria-label="ุฅููุงู ุงููุฑุงุกุฉ" disabled>
          โน ุฅููุงู
        </button>

        <div class="a11y-voice-select" role="radiogroup" aria-label="ุงุฎุชูุงุฑ ุงูุตูุช">
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-voice" value="female" checked>
            <span>๐ฉ ุฃูุซู</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-voice" value="male">
            <span>๐จ ุฐูุฑ</span>
          </label>
        </div>

        <button id="a11y-close" class="a11y-close-btn" type="button" aria-label="ุฅุบูุงู ุงูุดุฑูุท">โ</button>
      </div>

      <!-- Mini progress bar -->
      <div id="a11y-progress" class="a11y-progress hidden">
        <div id="a11y-progress-bar" class="a11y-progress-bar"></div>
        <span id="a11y-status" class="a11y-status">ุฌุงูุฒ</span>
      </div>
    </div>
  </div>

  <script>
    // Simple responsive nav toggle
    const btn = document.querySelector('[data-nav-toggle]');
    const nav = document.querySelector('[data-nav]');
    if (btn && nav) {
      btn.addEventListener('click', () => {
        const open = nav.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }

    // ===== Accessibility Toolbar Logic =====
    (function() {
      const fab = document.getElementById('a11y-fab');
      const panel = document.getElementById('a11y-panel');
      const readBtn = document.getElementById('a11y-read-page');
      const stopBtn = document.getElementById('a11y-stop');
      const closeBtn = document.getElementById('a11y-close');
      const progress = document.getElementById('a11y-progress');
      const progressBar = document.getElementById('a11y-progress-bar');
      const statusEl = document.getElementById('a11y-status');

      if (!fab || !panel) return;

      let toolbarAudio = null;
      let toolbarPlaying = false;

      // Toggle panel
      fab.addEventListener('click', () => {
        const isHidden = panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        fab.classList.toggle('active', isHidden);
        fab.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
      });

      closeBtn.addEventListener('click', () => {
        panel.classList.add('hidden');
        fab.classList.remove('active');
        fab.setAttribute('aria-expanded', 'false');
      });

      // Voice selector highlight
      panel.querySelectorAll('input[name="a11y-voice"]').forEach(radio => {
        radio.addEventListener('change', () => {
          panel.querySelectorAll('.a11y-voice-option').forEach(l => l.classList.remove('selected'));
          radio.closest('.a11y-voice-option')?.classList.add('selected');
        });
      });

      function getVoice() {
        const checked = panel.querySelector('input[name="a11y-voice"]:checked');
        return checked ? checked.value : 'female';
      }

      function getPageText() {
        const main = document.getElementById('main');
        if (!main) return '';
        // Get visible text from main content, skip scripts/styles
        const clone = main.cloneNode(true);
        clone.querySelectorAll('script, style, nav, .a11y-toolbar').forEach(el => el.remove());
        return (clone.textContent || clone.innerText || '').replace(/\s+/g, ' ').trim();
      }

      function setStatus(msg) {
        if (statusEl) statusEl.textContent = msg;
      }

      function showProgress(show) {
        if (progress) progress.classList.toggle('hidden', !show);
      }

      // Read page content via backend TTS
      readBtn.addEventListener('click', async () => {
        // Stop if already playing
        if (toolbarPlaying && toolbarAudio) {
          stopPlayback();
          return;
        }

        const text = getPageText();
        if (!text) {
          setStatus('ูุง ููุฌุฏ ูุญุชูู ูููุฑุงุกุฉ');
          showProgress(true);
          setTimeout(() => showProgress(false), 2000);
          return;
        }

        // Truncate to 2000 chars (API limit)
        const truncated = text.substring(0, 2000);
        const voice = getVoice();

        readBtn.disabled = true;
        stopBtn.disabled = false;
        showProgress(true);
        setStatus('โณ ุฌุงุฑู ุชุญุถูุฑ ุงูุตูุช...');
        progressBar.style.width = '30%';

        try {
          // Get CSRF token
          const csrfToken = (function() {
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
              c = c.trim();
              if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
            }
            return '';
          })();

          const response = await fetch('/service/tts/synthesize/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ text: truncated, voice: voice }),
          });

          progressBar.style.width = '60%';
          const data = await response.json();

          if (data.success && data.audio_url) {
            progressBar.style.width = '80%';
            toolbarAudio = new Audio(data.audio_url);

            toolbarAudio.onplay = () => {
              toolbarPlaying = true;
              setStatus('โถ ุฌุงุฑู ุงููุฑุงุกุฉ...');
              progressBar.style.width = '100%';
              readBtn.innerHTML = 'โธ ุฅููุงู ูุคูุช';
            };

            toolbarAudio.onended = () => {
              toolbarPlaying = false;
              toolbarAudio = null;
              setStatus('โ ุงูุชููุช ุงููุฑุงุกุฉ');
              readBtn.innerHTML = '๐ ูุฑุงุกุฉ ุงูุตูุญุฉ';
              readBtn.disabled = false;
              stopBtn.disabled = true;
              setTimeout(() => showProgress(false), 2000);
            };

            toolbarAudio.onerror = () => {
              setStatus('โ ุฎุทุฃ ูู ุชุดุบูู ุงูุตูุช โ ุฌุงุฑู ุงุณุชุฎุฏุงู ุงููุชุตูุญ...');
              toolbarPlaying = false;
              readBtn.innerHTML = '๐ ูุฑุงุกุฉ ุงูุตูุญุฉ';
              readBtn.disabled = false;
              stopBtn.disabled = true;
              // Fallback to browser TTS
              if (typeof playBrowserTTS === 'function') {
                playBrowserTTS(truncated, voice, 'normal');
              }
            };

            await toolbarAudio.play();
          } else {
            throw new Error(data.error || 'ูุดู ูู ุชุญุถูุฑ ุงูุตูุช');
          }

        } catch (err) {
          console.error('A11y TTS Error:', err);
          setStatus('ุฌุงุฑู ุงุณุชุฎุฏุงู ูุญุฑู ุงููุชุตูุญ...');
          // Fallback to browser Speech API
          if (typeof playBrowserTTS === 'function') {
            playBrowserTTS(truncated, getVoice(), 'normal');
          } else if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(truncated);
            utterance.lang = 'ar';
            utterance.rate = 0.9;
            speechSynthesis.speak(utterance);
          }
          readBtn.disabled = false;
          stopBtn.disabled = true;
          setTimeout(() => showProgress(false), 2000);
        }
      });

      // Stop
      stopBtn.addEventListener('click', () => {
        stopPlayback();
      });

      function stopPlayback() {
        if (toolbarAudio) {
          toolbarAudio.pause();
          toolbarAudio.currentTime = 0;
          toolbarAudio = null;
        }
        // Also stop browser speech
        if ('speechSynthesis' in window) {
          speechSynthesis.cancel();
        }
        // Also stop global tts.js audio
        if (typeof stopTTS === 'function') {
          stopTTS();
        }
        toolbarPlaying = false;
        readBtn.innerHTML = '๐ ูุฑุงุกุฉ ุงูุตูุญุฉ';
        readBtn.disabled = false;
        stopBtn.disabled = true;
        setStatus('ุชู ุงูุฅููุงู');
        setTimeout(() => showProgress(false), 1500);
      }
    })();
  </script>
</body>
</html>
