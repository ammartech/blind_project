{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Ù…Ù†ØµØ© ØµÙˆØªÙŠØ© Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…ÙƒÙÙˆÙÙŠÙ†{% endblock %}</title>

  <!-- IBM Plex (Arabic) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  {% block extra_css %}{% endblock %}
  <script defer src="{% static 'js/tts.js' %}"></script>
  {% block extra_js %}{% endblock %}
</head>
<body>
  <a class="skip-link" href="#main">ØªØ®Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</a>

  <header class="site-header">
    <nav class="navbar container">
      <a class="brand" href="{% url 'core:home' %}">
        <span class="brand-dot" aria-hidden="true"></span>
        <span>Ù…Ù†ØµØ© Ø·ÙŠØ¨Ø© Ø§Ù„ØµÙˆØªÙŠØ©</span>
      </a>

      <button class="nav-toggle" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-expanded="false" data-nav-toggle>â˜°</button>

      <ul class="nav-links" data-nav>
        <li><a href="{% url 'core:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li><a href="{% url 'core:services' %}">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</a></li>
        <li><a href="{% url 'glossary:list' %}">Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</a></li>
        <li><a href="{% url 'core:about' %}">Ù…Ù† Ù†Ø­Ù†</a></li>
        <li><a href="{% url 'core:contact' %}">ØªÙˆØ§ØµÙ„</a></li>
        {% if user.is_authenticated %}
          <li><a class="pill" href="{% url 'service:dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
          <li>
            <form method="post" action="{% url 'accounts:logout' %}">
              {% csrf_token %}
              <button class="linklike" type="submit">Ø®Ø±ÙˆØ¬</button>
            </form>
          </li>
        {% else %}
          <li><a class="pill" href="{% url 'accounts:login' %}">Ø¯Ø®ÙˆÙ„</a></li>
          <li><a class="pill outline" href="{% url 'accounts:register' %}">ØªØ³Ø¬ÙŠÙ„</a></li>
        {% endif %}
      </ul>
    </nav>
  </header>

  {% if messages %}
    <div class="container">
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Force CSRF cookie to be set on every page (needed for TTS AJAX) -->
  <div style="display:none">{% csrf_token %}</div>

  <main id="main" class="container main">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>Ù…Ù† Ù†Ø­Ù†</h3>
        <p>
          Ù…Ù†ØµØ© ØµÙˆØªÙŠØ© Ø±Ù‚Ù…ÙŠØ© Ù„Ø¯Ø¹Ù… Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ù…ÙƒÙÙˆÙÙŠÙ† ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠØ© â€” Ø¯Ø±Ø§Ø³Ø© ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ø¹Ù„Ù‰ Ø¬Ø§Ù…Ø¹Ø© Ø·ÙŠØ¨Ø©.
          Ù†Ø­ÙˆÙ„ ØµÙˆØª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ Ø¥Ù„Ù‰ Ù†ØµØŒ Ø«Ù… ÙŠØ¬ÙŠØ¨ Ø£Ø®ØµØ§Ø¦ÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù†ØµÙŠÙ‹Ø§ØŒ ÙˆÙŠØ¹ÙˆØ¯ Ø§Ù„Ø±Ø¯ Ø¨ØµÙˆØª ÙˆØ§Ø¶Ø­ Ù„Ù„Ù…Ø³ØªÙÙŠØ¯.
        </p>
      </div>
      <div>
        <h3>Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h3>
        <ul class="footer-links">
          <li><a href="{% url 'core:services' %}">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</a></li>
          <li><a href="{% url 'glossary:list' %}">Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</a></li>
          <li><a href="{% url 'core:about' %}">Ù…Ù† Ù†Ø­Ù†</a></li>
          <li><a href="{% url 'core:contact' %}">ØªÙˆØ§ØµÙ„</a></li>
        </ul>
      </div>
      <div>
        <h3>Ø¥ØªØ§Ø­Ø© Ø§Ù„ÙˆØµÙˆÙ„</h3>
        <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© ØµÙˆØªÙŠØ© Ù„Ø£ÙŠ Ù†Øµ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø«Ø§Ø¨Øª (ğŸ”Š) Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©.</p>
      </div>
    </div>
    <div class="container footer-bottom">
      <small>Â© {% now "Y" %} Ù…Ù†ØµØ© Ø·ÙŠØ¨Ø© Ø§Ù„ØµÙˆØªÙŠØ© â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</small>
    </div>
  </footer>

  <!-- Auto-read idle indicator -->
  <div id="autoread-indicator" class="autoread-indicator hidden" role="status" aria-live="polite">
    <span class="autoread-text">ğŸ“– Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©...</span>
  </div>

  <!-- ===== Global Accessibility TTS Toolbar ===== -->
  <div id="a11y-toolbar" class="a11y-toolbar" role="region" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©">
    <button id="a11y-fab" class="a11y-fab" type="button"
            aria-label="ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©"
            title="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©"
            aria-expanded="false">
      ğŸ”Š
    </button>

    <div id="a11y-panel" class="a11y-panel hidden" role="toolbar" aria-label="Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">
      <div class="a11y-panel-header">
        <span class="a11y-panel-title">ğŸ§ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©</span>
        <button id="a11y-close" class="a11y-close-btn" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      </div>

      <!-- Engine toggle -->
      <div class="a11y-panel-row">
        <span class="a11y-label">Ø§Ù„Ù…Ø­Ø±Ùƒ:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="Ù…Ø­Ø±Ùƒ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-engine" value="ai" checked>
            <span>ğŸ¤– Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-engine" value="browser">
            <span>ğŸŒ Ø§Ù„Ù…ØªØµÙØ­</span>
          </label>
        </div>
      </div>

      <!-- Voice -->
      <div class="a11y-panel-row">
        <span class="a11y-label">Ø§Ù„ØµÙˆØª:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª">
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-voice" value="female" checked>
            <span>ğŸ‘© Ø£Ù†Ø«Ù‰</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-voice" value="male">
            <span>ğŸ‘¨ Ø°ÙƒØ±</span>
          </label>
        </div>
      </div>

      <!-- Speed -->
      <div class="a11y-panel-row">
        <span class="a11y-label">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-speed" value="slow">
            <span>ğŸ¢ Ø¨Ø·ÙŠØ¡</span>
          </label>
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-speed" value="normal" checked>
            <span>â–¶ï¸ Ø¹Ø§Ø¯ÙŠ</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-speed" value="fast">
            <span>âš¡ Ø³Ø±ÙŠØ¹</span>
          </label>
        </div>
      </div>

      <div class="a11y-panel-actions">
        <button id="a11y-read-page" class="a11y-action-btn primary" type="button">
          ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©
        </button>
        <button id="a11y-stop" class="a11y-action-btn danger" type="button" disabled>
          â¹ Ø¥ÙŠÙ‚Ø§Ù
        </button>
      </div>

      <div id="a11y-progress" class="a11y-progress hidden">
        <span id="a11y-status" class="a11y-status"></span>
      </div>
    </div>
  </div>

  <script>
    // Responsive nav toggle
    const btn = document.querySelector('[data-nav-toggle]');
    const nav = document.querySelector('[data-nav]');
    if (btn && nav) {
      btn.addEventListener('click', () => {
        const open = nav.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }

    // ===== Accessibility Toolbar =====
    (function() {
      const fab = document.getElementById('a11y-fab');
      const panel = document.getElementById('a11y-panel');
      const readBtn = document.getElementById('a11y-read-page');
      const stopBtn = document.getElementById('a11y-stop');
      const closeBtn = document.getElementById('a11y-close');
      const progress = document.getElementById('a11y-progress');
      const statusEl = document.getElementById('a11y-status');
      if (!fab || !panel) return;

      let toolbarAudio = null;
      let toolbarPlaying = false;

      function getCSRF() {
        for (let c of document.cookie.split(';')) {
          c = c.trim();
          if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
        }
        return '';
      }

      // Toggle panel
      fab.addEventListener('click', () => {
        const opening = panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        fab.classList.toggle('active', opening);
        fab.setAttribute('aria-expanded', String(opening));
      });
      closeBtn.addEventListener('click', () => {
        panel.classList.add('hidden');
        fab.classList.remove('active');
        fab.setAttribute('aria-expanded', 'false');
      });

      // Highlight sync for all radio groups in panel
      panel.querySelectorAll('.a11y-voice-option input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          const group = r.closest('.a11y-option-group, .a11y-voice-select');
          if (group) {
            group.querySelectorAll('.a11y-voice-option').forEach(l => l.classList.remove('selected'));
          }
          r.closest('.a11y-voice-option')?.classList.add('selected');
        });
      });

      function getVoice() {
        return panel.querySelector('input[name="a11y-voice"]:checked')?.value || 'female';
      }
      function getEngine() {
        return panel.querySelector('input[name="a11y-engine"]:checked')?.value || 'ai';
      }
      function getSpeed() {
        return panel.querySelector('input[name="a11y-speed"]:checked')?.value || 'normal';
      }

      function getPageText() {
        const main = document.getElementById('main');
        if (!main) return '';
        const clone = main.cloneNode(true);
        clone.querySelectorAll('script,style,nav,button,input,select,label,.a11y-toolbar,.breadcrumb,.back-link,.tts-settings,.tts-actions,.tts-controls').forEach(el => el.remove());
        return (clone.textContent || '').replace(/\s+/g, ' ').trim();
      }

      function setStatus(msg, autoHide) {
        if (!statusEl || !progress) return;
        statusEl.textContent = msg;
        progress.classList.remove('hidden');
        if (autoHide) setTimeout(() => progress.classList.add('hidden'), 3500);
      }

      // Read page
      readBtn.addEventListener('click', async () => {
        if (toolbarPlaying) { stopPlayback(); return; }

        const text = getPageText();
        if (!text) { setStatus('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø©', true); return; }

        const truncated = text.substring(0, 2000);
        const voice = getVoice();
        const speed = getSpeed();
        const engine = getEngine();

        // Browser engine path
        if (engine === 'browser') {
          doBrowserTTS(truncated, voice, speed);
          return;
        }

        // AI engine path
        readBtn.disabled = true;
        stopBtn.disabled = false;
        readBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        readBtn.classList.add('loading');

        try {
          const res = await fetch('/service/tts/synthesize/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
            body: JSON.stringify({ text: truncated, voice, speed }),
          });
          const data = await res.json();

          if (data.success && data.audio_url) {
            toolbarAudio = new Audio(data.audio_url);
            const rateMap = { slow: 0.85, normal: 1.0, fast: 1.2 };
            toolbarAudio.playbackRate = rateMap[speed] || 1.0;

            toolbarAudio.onplay = () => {
              toolbarPlaying = true;
              readBtn.innerHTML = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
              readBtn.classList.remove('loading');
              readBtn.classList.add('playing');
              readBtn.disabled = false;
              setStatus('â–¶ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©...');
            };
            toolbarAudio.onended = () => { resetUI(); setStatus('âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', true); };
            toolbarAudio.onerror = () => { resetUI(); doBrowserTTS(truncated, voice, speed); };

            await toolbarAudio.play();
          } else {
            throw new Error(data.error || 'ÙØ´Ù„');
          }
        } catch (err) {
          console.error('A11y TTS:', err);
          resetUI();
          doBrowserTTS(truncated, voice, speed);
        }
      });

      stopBtn.addEventListener('click', stopPlayback);

      function stopPlayback() {
        if (toolbarAudio) { toolbarAudio.pause(); toolbarAudio = null; }
        if ('speechSynthesis' in window) speechSynthesis.cancel();
        if (typeof stopTTS === 'function') stopTTS();
        resetUI();
        setStatus('â¹ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù', true);
      }

      function resetUI() {
        toolbarPlaying = false;
        toolbarAudio = null;
        readBtn.innerHTML = 'ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø©';
        readBtn.classList.remove('loading', 'playing');
        readBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function doBrowserTTS(text, voice, speed) {
        if (!('speechSynthesis' in window)) {
          setStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©', true);
          return;
        }
        speechSynthesis.cancel();
        setStatus('ğŸ”Š Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¨Ø± Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…ØªØµÙØ­');
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ar';
        const speedMap = { slow: 0.7, normal: 0.9, fast: 1.4 };
        u.rate = speedMap[speed] || 0.9;
        const voices = speechSynthesis.getVoices();
        const arVoice = voices.find(v => v.lang.startsWith('ar'));
        if (arVoice) u.voice = arVoice;
        u.onend = () => { resetUI(); setStatus('âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', true); };
        toolbarPlaying = true;
        readBtn.innerHTML = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
        readBtn.classList.add('playing');
        readBtn.disabled = false;
        stopBtn.disabled = false;
        speechSynthesis.speak(u);
      }
    })();

    // ===== Auto-Read on Mouse Idle (20s) â€” once per page load =====
    (function() {
      const IDLE_TIMEOUT = 20000;
      let idleTimer = null;
      let hasAutoRead = false; // True once fired; NEVER resets â€” one read per page load
      let userInteracted = false;
      let autoReadAborted = false;

      // â”€â”€ CSRF helper â”€â”€
      function csrf() {
        for (let c of document.cookie.split(';')) {
          c = c.trim();
          if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
        }
        return '';
      }

      // â”€â”€ Extract sections [{label, text}] from main content â”€â”€
      function extractSections() {
        const main = document.getElementById('main');
        if (!main) return [];

        const clone = main.cloneNode(true);
        // Remove noise
        clone.querySelectorAll([
          'script', 'style', 'button', 'input', 'select', 'label',
          'nav', 'form', '.breadcrumb', '.back-link', '.stt-panel',
          '.tts-settings', '.tts-actions', '.tts-controls', '.form-actions',
          '.stats-card', '.term-stats', '.filter-form', '.filter-row',
          '.pagination', '.actions-bar', '.actions-card', '.meta-badges',
          '.meta-info', '.inquiry-badges', '.welcome-actions', '.stats-grid'
        ].join(',')).forEach(el => el.remove());

        // Walk headings + following content
        const nodes = Array.from(clone.querySelectorAll(
          'h1, h2, h3, p, .para, .definition-text, .hint, li, .inquiry-preview, ' +
          '.empty-state, .stat-content, .tip-icon + span, .inquiry-title'
        ));

        const sections = [];
        let current = null;

        for (const node of nodes) {
          const tag = node.tagName?.toLowerCase();
          if (tag === 'h1' || tag === 'h2' || tag === 'h3') {
            if (current && (current.label || current.text.trim())) {
              sections.push(current);
            }
            current = { label: node.textContent.trim(), text: '' };
          } else if (current) {
            const t = node.textContent.trim();
            if (t && t !== current.label) {
              current.text += t + '. ';
            }
          } else {
            // Content before any heading
            const t = node.textContent.trim();
            if (t) {
              current = { label: '', text: t + '. ' };
            }
          }
        }
        if (current && (current.label || current.text.trim())) sections.push(current);

        // Fallback: if no structured sections found, use full page text
        if (!sections.length) {
          const text = clone.textContent.replace(/\s+/g, ' ').trim();
          if (text) sections.push({ label: '', text });
        }
        return sections;
      }

      // â”€â”€ Speak one chunk via AI backend, returns Promise â”€â”€
      function speakChunk(text) {
        return new Promise((resolve) => {
          if (autoReadAborted || !text.trim()) { resolve(); return; }

          const voice = document.querySelector('input[name="a11y-voice"]:checked')?.value || 'female';
          const speed = document.querySelector('input[name="a11y-speed"]:checked')?.value || 'normal';
          const engine = document.querySelector('input[name="a11y-engine"]:checked')?.value || 'ai';

          if (engine === 'browser') {
            // Browser speech synthesis
            if (!('speechSynthesis' in window)) { resolve(); return; }
            const u = new SpeechSynthesisUtterance(text.substring(0, 2000));
            u.lang = 'ar';
            const rateMap = { slow: 0.7, normal: 0.9, fast: 1.4 };
            u.rate = rateMap[speed] || 0.9;
            u.onend = u.onerror = resolve;
            speechSynthesis.speak(u);
            return;
          }

          // AI engine
          fetch('/service/tts/synthesize/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf() },
            body: JSON.stringify({ text: text.substring(0, 2000), voice, speed }),
          })
          .then(r => r.json())
          .then(data => {
            if (autoReadAborted || !data.success || !data.audio_url) { resolve(); return; }
            const audio = new Audio(data.audio_url);
            audio.onended = resolve;
            audio.onerror = () => {
              // fallback browser speech
              if ('speechSynthesis' in window) {
                const u = new SpeechSynthesisUtterance(text.substring(0, 2000));
                u.lang = 'ar'; u.rate = 0.9;
                u.onend = u.onerror = resolve;
                speechSynthesis.speak(u);
              } else resolve();
            };
            audio.play().catch(resolve);
          })
          .catch(resolve);
        });
      }

      // â”€â”€ Update the indicator label â”€â”€
      function setIndicatorText(text) {
        const el = document.getElementById('autoread-indicator');
        const span = el?.querySelector('.autoread-text');
        if (el && span) {
          el.classList.remove('hidden');
          span.textContent = text;
        }
      }

      function hideIndicator() {
        const el = document.getElementById('autoread-indicator');
        if (el) el.classList.add('hidden');
      }

      // â”€â”€ Main auto-read: read page section by section â”€â”€
      async function triggerAutoRead() {
        autoReadAborted = false;

        const sections = extractSections();
        if (!sections.length) return;

        // Open toolbar panel so user can see controls
        const panel = document.getElementById('a11y-panel');
        const fab = document.getElementById('a11y-fab');
        if (panel?.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          fab?.classList.add('active');
          fab?.setAttribute('aria-expanded', 'true');
        }

        // Mark stop button active
        const stopBtn = document.getElementById('a11y-stop');
        if (stopBtn) stopBtn.disabled = false;

        for (let i = 0; i < sections.length; i++) {
          if (autoReadAborted) break;
          const { label, text } = sections[i];

          // Update indicator with section title
          const display = label || `Ø§Ù„Ù‚Ø³Ù… ${i + 1}`;
          setIndicatorText(`ğŸ“– ${display}`);

          // Read heading, then content
          if (label) await speakChunk(label);
          if (!autoReadAborted && text.trim()) await speakChunk(text.trim());
        }

        if (!autoReadAborted) setIndicatorText('âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');
        setTimeout(hideIndicator, 3000);

        if (stopBtn) stopBtn.disabled = true;
      }

      // â”€â”€ Stop auto-read from stop button â”€â”€
      document.addEventListener('DOMContentLoaded', () => {
        const stopBtn = document.getElementById('a11y-stop');
        if (stopBtn) {
          const origClick = stopBtn.onclick;
          stopBtn.addEventListener('click', () => {
            autoReadAborted = true;
            if ('speechSynthesis' in window) speechSynthesis.cancel();
            hideIndicator();
          });
        }
      });

      // â”€â”€ Idle tracking â€” hasAutoRead never resets â”€â”€
      function startIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);
        if (hasAutoRead) return; // Already fired this page load â€” never again

        idleTimer = setTimeout(() => {
          if (hasAutoRead) return;
          if (typeof isPlaying !== 'undefined' && isPlaying) return;
          if (document.querySelector('.stt-panel, form.form')) return;

          hasAutoRead = true; // Lock â€” will never reset
          triggerAutoRead();
        }, IDLE_TIMEOUT);
      }

      // Reset timer on activity (but NOT hasAutoRead)
      ['mousemove', 'mousedown', 'touchstart', 'keydown', 'scroll'].forEach(evt => {
        document.addEventListener(evt, () => {
          userInteracted = true;
          if (!hasAutoRead) startIdleTimer(); // Only restart if not yet fired
        }, { passive: true });
      });

      // Start on page load
      document.addEventListener('DOMContentLoaded', () => {
        if (document.querySelector('form.form, .stt-panel')) return; // Skip form pages
        // Kick off immediately â€” user activity will reset the timer
        startIdleTimer();
      });
    })();
  </script>
</body>
</html>
