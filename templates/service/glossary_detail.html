{% extends 'base.html' %}

{% block title %}{{ term.term }} | Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª{% endblock %}

{% block content %}

<div class="page-head">
  <nav class="breadcrumb" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
    <a href="{% url 'service:glossary_list' %}">Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</a>
    <span class="separator">â€º</span>
    <span>{{ term.term }}</span>
  </nav>

  <h1>{{ term.term }}</h1>

  {% if term.pronunciation_hint %}
    <p class="pronunciation-hint">
      <span class="label">ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù†Ø·Ù‚:</span>
      <strong>{{ term.pronunciation_hint }}</strong>
    </p>
  {% endif %}
</div>

<div class="card">
  <h2>Ø§Ù„ØªØ¹Ø±ÙŠÙ</h2>
  <p class="para definition-text">
    {{ term.definition|linebreaksbr }}
  </p>

  <!-- Voice selector -->
  <div class="tts-controls">
    <span class="tts-controls-label">ğŸ”Š Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©:</span>
    <div class="voice-selector" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª">
      <label class="voice-option selected">
        <input type="radio" name="tts-voice" value="female" checked>
        <span>ğŸ‘© Ø£Ù†Ø«Ù‰</span>
      </label>
      <label class="voice-option">
        <input type="radio" name="tts-voice" value="male">
        <span>ğŸ‘¨ Ø°ÙƒØ±</span>
      </label>
    </div>
  </div>

  <!-- Glossary TTS -->
  <div class="row">
    <button class="tts-btn" type="button" onclick="playGlossaryTTSWithVoice({{ term.pk }}, 'full')">
      ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙ
    </button>
  </div>

  <p class="hint">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰) Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.</p>
</div>

<div class="card stats-card">
  <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
  <div class="term-stats">
    <span>ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: {{ term.view_count }}</span>
    <span>ğŸ”Š Ù…Ø±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„: {{ term.tts_play_count }}</span>
    <span>ğŸ“… Ø£Ø¶ÙŠÙ: {{ term.created_at|date:"Y/m/d" }}</span>
  </div>
</div>

{% if user.is_authenticated and user.is_librarian %}
<div class="actions-card">
  <a class="btn secondary" href="{% url 'service:glossary_edit' term.pk %}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>

  <form method="post" action="{% url 'service:glossary_delete' term.pk %}"
        class="inline-form"
        onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ·Ù„Ø­ØŸ')">
    {% csrf_token %}
    <button class="btn danger-outline" type="submit">ğŸ—‘ï¸ Ø­Ø°Ù</button>
  </form>
</div>
{% endif %}

<div class="back-link">
  <a class="btn outline" href="{% url 'service:glossary_list' %}">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ù…ÙˆØ³</a>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // --- UI: keep selected style in sync ---
  function syncVoiceSelectedUI() {
    document.querySelectorAll('.voice-option').forEach(label => label.classList.remove('selected'));
    const checked = document.querySelector('input[name="tts-voice"]:checked');
    if (checked) checked.closest('.voice-option')?.classList.add('selected');
  }
  document.querySelectorAll('input[name="tts-voice"]').forEach(r => {
    r.addEventListener('change', syncVoiceSelectedUI);
  });
  syncVoiceSelectedUI();

  function getSelectedVoice() {
    const checked = document.querySelector('input[name="tts-voice"]:checked');
    return checked ? checked.value : 'female';
  }

  // Wrapper: calls your global function, but passes voice too (if supported)
  function playGlossaryTTSWithVoice(termPk, mode) {
    const voice = getSelectedVoice();

    // If your global function accepts voice: playGlossaryTTS(pk, mode, voice)
    if (typeof window.playGlossaryTTS === 'function') {
      try {
        // Try 3-args first
        window.playGlossaryTTS(termPk, mode, voice);
        return;
      } catch (e) {
        // fallback below
      }

      // fallback to 2 args (if you implemented voice reading inside playGlossaryTTS)
      window.playGlossaryTTS(termPk, mode);
      return;
    }

    // If you didn't add the function yet, show helpful message
    alert('Ø¯Ø§Ù„Ø© playGlossaryTTS ØºÙŠØ± Ù…Ø¹Ø±ÙØ© Ø¨Ø¹Ø¯. Ø£Ø¶ÙÙ‡Ø§ ÙÙŠ Ù…Ù„Ù JS Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ TTS.');
  }
</script>
{% endblock %}
