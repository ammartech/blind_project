{% extends 'base.html' %}
{% block title %}ุงุณุชูุณุงุฑ ุฌุฏูุฏ | ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ{% endblock %}

{% block content %}
<div class="page-head">
  <nav class="breadcrumb" aria-label="ุงูุชููู">
    <a href="{% url 'service:dashboard' %}">ููุญุฉ ุงูุชุญูู</a>
    <span class="separator">></span>
    <span>ุงุณุชูุณุงุฑ ุฌุฏูุฏ</span>
  </nav>
  <h1>ุฅุฑุณุงู ุงุณุชูุณุงุฑ ุฌุฏูุฏ</h1>
  <p class="muted">ููููู ูุชุงุจุฉ ุณุคุงูู ุฃู ุงุณุชุฎุฏุงู ุงูุฅููุงุก ุงูุตูุชู ุฃู ุฑูุน ููู ุตูุชู.</p>
</div>

<div class="card">
  <form method="post" enctype="multipart/form-data" class="form" id="inquiry-form">
    {% csrf_token %}

    {{ form.non_field_errors }}

    <!-- Title Field with inline mic -->
    <div class="form-row" id="field-row-title">
      <div class="field-label-row">
        <label for="{{ form.title.id_for_label }}">ุนููุงู ุงูุงุณุชูุณุงุฑ *</label>
        <button type="button" class="stt-inline-btn" data-stt-target="title" aria-label="ุฅููุงุก ุงูุนููุงู ุตูุชูุงู" title="ุฅููุงุก ุงูุนููุงู ุตูุชูุงู">
          ๐ค
        </button>
      </div>
      {{ form.title }}
      {{ form.title.errors }}
      <p class="field-hint">ุงูุชุจ ุนููุงูุงู ูุฎุชุตุฑุงู ูุตู ุณุคุงูู</p>
    </div>

    <!-- Question Text Field with inline mic -->
    <div class="form-row" id="field-row-question">
      <div class="field-label-row">
        <label for="{{ form.question_text.id_for_label }}">ูุต ุงูุณุคุงู</label>
        <button type="button" class="stt-inline-btn" data-stt-target="question" aria-label="ุฅููุงุก ุงูุณุคุงู ุตูุชูุงู" title="ุฅููุงุก ุงูุณุคุงู ุตูุชูุงู">
          ๐ค
        </button>
      </div>
      {{ form.question_text }}
      {{ form.question_text.errors }}
      <p class="field-hint">ุงูุชุจ ุณุคุงูู ููุงุ ุฃู ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู ุฃุฏูุงูุ ุฃู ุงุฑูุน ููู ุตูุชู</p>
    </div>

    <!-- Voice Recognition (STT) Panel -->
    <div class="stt-panel card" id="stt-panel">
      <h3>๐ค ุงูุฅููุงุก ุงูุตูุชู</h3>
      <p class="hint">ุชุญุฏุซ ูุณูุชู ุชุญููู ููุงูู ุฅูู ูุต ุชููุงุฆูุงู. ุงุฎุชุฑ ุงูุญูู ุงููุณุชูุฏู ุซู ุงุจุฏุฃ ุงูุชุณุฌูู.</p>

      <!-- STT Mode selector -->
      <div class="tts-setting-group">
        <span class="tts-setting-label">ูุถุน ุงูุชุนุฑู:</span>
        <div class="voice-selector" role="radiogroup" aria-label="ูุถุน ุงูุชุนุฑู ุนูู ุงูุตูุช">
          <label class="voice-option selected" id="stt-mode-browser-label">
            <input type="radio" name="stt-mode" value="browser" checked>
            <span>๐ ุงููุชุตูุญ (ูุจุงุดุฑ)</span>
          </label>
          <label class="voice-option" id="stt-mode-backend-label">
            <input type="radio" name="stt-mode" value="backend">
            <span>๐ค ุงูุฎุงุฏู (ุชุณุฌูู ูุฅุฑุณุงู)</span>
          </label>
        </div>
      </div>

      <!-- Target field selector -->
      <div class="tts-setting-group">
        <span class="tts-setting-label">ุงูุญูู ุงููุณุชูุฏู:</span>
        <div class="voice-selector" role="radiogroup" aria-label="ุงูุญูู ุงููุณุชูุฏู ููุฅููุงุก">
          <label class="voice-option stt-target-option" id="stt-target-title">
            <input type="radio" name="stt-target" value="title">
            <span>๐ ุงูุนููุงู</span>
          </label>
          <label class="voice-option stt-target-option selected" id="stt-target-question">
            <input type="radio" name="stt-target" value="question" checked>
            <span>๐ฌ ูุต ุงูุณุคุงู</span>
          </label>
        </div>
      </div>

      <!-- Language selector -->
      <div class="tts-setting-group">
        <span class="tts-setting-label">ุงููุบุฉ:</span>
        <div class="voice-selector" role="radiogroup" aria-label="ูุบุฉ ุงูุฅููุงุก">
          <label class="voice-option selected">
            <input type="radio" name="stt-lang" value="ar-SA" checked>
            <span>๐ธ๐ฆ ุงูุนุฑุจูุฉ</span>
          </label>
          <label class="voice-option">
            <input type="radio" name="stt-lang" value="en-US">
            <span>๐บ๐ธ English</span>
          </label>
        </div>
      </div>

      <!-- STT controls -->
      <div class="stt-controls">
        <button type="button" id="stt-start" class="btn primary stt-btn" aria-label="ุจุฏุก ุงูุชุณุฌูู">
          ๐ค ุงุจุฏุฃ ุงูุชุณุฌูู
        </button>
        <button type="button" id="stt-stop" class="btn danger stt-btn" disabled aria-label="ุฅููุงู ุงูุชุณุฌูู">
          โน ุฅููุงู
        </button>
        <button type="button" id="stt-clear" class="btn outline stt-btn" aria-label="ูุณุญ ุงูุญูู">
          ๐ ูุณุญ ุงูุญูู
        </button>
      </div>

      <!-- Active target indicator -->
      <div id="stt-target-indicator" class="stt-target-indicator">
        <span class="stt-target-icon">๐ฏ</span>
        <span id="stt-target-label">ุงูุฅููุงุก ูู: <strong>ูุต ุงูุณุคุงู</strong></span>
      </div>

      <!-- Status indicator -->
      <div id="stt-status" class="stt-status hidden" role="status" aria-live="polite">
        <span class="stt-pulse"></span>
        <span id="stt-status-text">ุฌุงูุฒ</span>
      </div>

      <!-- Voice commands hint -->
      <div class="stt-commands-hint">
        <strong>ุงูุฃูุงูุฑ ุงูุตูุชูุฉ (ูุถุน ุงููุชุตูุญ):</strong><br>
        <span class="stt-cmd">ยซุนููุงูยป</span> ูููุชุงุจุฉ ูู ุงูุนููุงู &nbsp;
        <span class="stt-cmd">ยซุณุคุงูยป</span> ูููุชุงุจุฉ ูู ูุต ุงูุณุคุงู &nbsp;
        <span class="stt-cmd">ยซุณุฌููยป</span> ูุจุฏุก ุงูุชุณุฌูู &nbsp;
        <span class="stt-cmd">ยซุชููููยป</span> ูุฅููุงู ุงูุชุณุฌูู &nbsp;
        <span class="stt-cmd">ยซุงูุณุญยป</span> ููุณุญ ุงูุญูู &nbsp;
        <span class="stt-cmd">ยซุฃุฑุณูยป</span> ูุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ
      </div>
    </div>

    <!-- Audio file upload with auto-transcribe -->
    <div class="form-row">
      <label for="{{ form.question_audio.id_for_label }}">ููู ุตูุชู (ุงุฎุชูุงุฑู)</label>
      <div class="file-upload-wrapper">
        {{ form.question_audio }}
        <p class="field-hint">ุงููููุงุช ุงููุฏุนููุฉ: MP3, WAV, OGG, M4A, WebM (ุงูุญุฏ ุงูุฃูุตู: 10 ููุฌุงุจุงูุช)</p>
      </div>
      {{ form.question_audio.errors }}

      <!-- Auto-transcribe panel -->
      <div id="auto-transcribe-panel" class="hidden" style="margin-top: 0.5rem;">
        <button type="button" id="auto-transcribe-btn" class="btn secondary">
          ๐ฏ ุชูุฑูุบ ุงูููู ุงูุตูุชู ุชููุงุฆูุงู
        </button>
        <span id="transcribe-status" class="hint" style="margin-right: 0.5rem;"></span>
      </div>
    </div>

    <div class="form-row">
      <label for="{{ form.priority.id_for_label }}">ุงูุฃููููุฉ</label>
      {{ form.priority }}
      {{ form.priority.errors }}
    </div>

    <div class="form-actions">
      <button class="btn primary" type="submit" id="submit-btn">ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ</button>
      <a class="btn outline" href="{% url 'service:dashboard' %}">ุฅูุบุงุก</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  // โโโโ CSRF helper โโโโ
  function getCSRF() {
    for (let c of document.cookie.split(';')) {
      c = c.trim();
      if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
    }
    return '';
  }

  // โโโโ DOM refs โโโโ
  const startBtn = document.getElementById('stt-start');
  const stopBtn = document.getElementById('stt-stop');
  const clearBtn = document.getElementById('stt-clear');
  const statusDiv = document.getElementById('stt-status');
  const statusText = document.getElementById('stt-status-text');
  const targetLabel = document.getElementById('stt-target-label');
  const submitBtn = document.getElementById('submit-btn');
  const form = document.getElementById('inquiry-form');

  const fields = {
    title: document.getElementById('id_title'),
    question: document.getElementById('id_question_text')
  };
  const fieldRows = {
    title: document.getElementById('field-row-title'),
    question: document.getElementById('field-row-question')
  };
  const fieldNames = {
    title: 'ุงูุนููุงู',
    question: 'ูุต ุงูุณุคุงู'
  };

  let activeTarget = 'question';

  // โโโโ Mode detection โโโโ
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const hasBrowserSTT = !!SpeechRecognition;

  // If no browser STT, force backend mode
  if (!hasBrowserSTT) {
    const browserOption = document.getElementById('stt-mode-browser-label');
    if (browserOption) {
      browserOption.style.opacity = '0.5';
      browserOption.querySelector('input').disabled = true;
    }
    const backendRadio = document.querySelector('input[name="stt-mode"][value="backend"]');
    if (backendRadio) {
      backendRadio.checked = true;
      backendRadio.closest('.voice-option')?.classList.add('selected');
    }
  }

  function getSTTMode() {
    const el = document.querySelector('input[name="stt-mode"]:checked');
    return el ? el.value : (hasBrowserSTT ? 'browser' : 'backend');
  }

  function getLang() {
    const el = document.querySelector('input[name="stt-lang"]:checked');
    return el ? el.value : 'ar-SA';
  }

  // โโโโ Target field management โโโโ
  function setTarget(target) {
    if (!fields[target]) return;
    activeTarget = target;

    document.querySelectorAll('input[name="stt-target"]').forEach(r => {
      r.closest('.stt-target-option')?.classList.remove('selected');
      if (r.value === target) {
        r.checked = true;
        r.closest('.stt-target-option')?.classList.add('selected');
      }
    });

    targetLabel.innerHTML = 'ุงูุฅููุงุก ูู: <strong>' + fieldNames[target] + '</strong>';
    Object.values(fieldRows).forEach(row => row?.classList.remove('stt-active-field'));
    fieldRows[target]?.classList.add('stt-active-field');
    fields[target]?.focus();
  }

  function getActiveField() {
    return fields[activeTarget] || fields.question;
  }

  // โโโโ Radio group sync โโโโ
  document.querySelectorAll('input[name="stt-target"]').forEach(r => {
    r.addEventListener('change', function() { setTarget(this.value); });
  });

  document.querySelectorAll('input[name="stt-lang"]').forEach(r => {
    r.addEventListener('change', function() {
      document.querySelectorAll('[name="stt-lang"]').forEach(radio => {
        radio.closest('.voice-option')?.classList.remove('selected');
      });
      this.closest('.voice-option')?.classList.add('selected');
    });
  });

  document.querySelectorAll('input[name="stt-mode"]').forEach(r => {
    r.addEventListener('change', function() {
      document.querySelectorAll('[name="stt-mode"]').forEach(radio => {
        radio.closest('.voice-option')?.classList.remove('selected');
      });
      this.closest('.voice-option')?.classList.add('selected');
      // Stop any active recording when switching modes
      stopListening();
    });
  });

  // โโโโ Inline mic buttons โโโโ
  document.querySelectorAll('.stt-inline-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      setTarget(this.dataset.sttTarget);
      if (!isListening) startListening();
    });
  });

  // ============================================
  // Browser STT (Web Speech API)
  // ============================================
  let recognition = null;
  let isListening = false;

  function createRecognition() {
    const rec = new SpeechRecognition();
    rec.lang = getLang();
    rec.continuous = true;
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    return rec;
  }

  function startBrowserSTT() {
    if (isListening) return;

    recognition = createRecognition();

    recognition.onstart = () => {
      isListening = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      startBtn.classList.add('recording');
      statusDiv.classList.remove('hidden');
      statusText.textContent = '๐ด ุฌุงุฑู ุงูุงุณุชูุงุน โ ' + fieldNames[activeTarget];
      fieldRows[activeTarget]?.classList.add('stt-active-field');
      document.querySelectorAll('.stt-inline-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.sttTarget === activeTarget);
      });
    };

    recognition.onresult = (e) => {
      let interim = '';
      let finalText = '';

      for (let i = e.resultIndex; i < e.results.length; i++) {
        const transcript = e.results[i][0].transcript;
        if (e.results[i].isFinal) {
          finalText += transcript;
        } else {
          interim += transcript;
        }
      }

      if (finalText) {
        const cmd = checkVoiceCommand(finalText.trim());
        if (cmd) return;

        const field = getActiveField();
        const current = field.value;
        const sep = current && !current.endsWith(' ') && !current.endsWith('\n') ? ' ' : '';
        field.value = current + sep + finalText.trim();
        field.dispatchEvent(new Event('input', { bubbles: true }));
      }

      if (interim) {
        statusText.textContent = '๐ด [' + fieldNames[activeTarget] + '] ' + interim;
      }
    };

    recognition.onerror = (e) => {
      console.error('STT Error:', e.error);
      if (e.error === 'no-speech') {
        statusText.textContent = 'โ ูู ูุชู ุฑุตุฏ ููุงู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.';
      } else if (e.error === 'not-allowed') {
        statusText.textContent = 'โ ูุฑุฌู ุงูุณูุงุญ ุจุงููุตูู ุฅูู ุงููููุฑูููู.';
      } else {
        statusText.textContent = 'โ ุฎุทุฃ: ' + e.error;
      }
      setTimeout(() => { if (!isListening) statusDiv.classList.add('hidden'); }, 3000);
    };

    recognition.onend = () => {
      if (isListening) {
        try { recognition.start(); } catch(e) { stopListening(); }
        return;
      }
      stopListening();
    };

    try {
      recognition.start();
    } catch(e) {
      statusText.textContent = 'โ ุชุนุฐุฑ ุจุฏุก ุงูุชุนุฑู ุนูู ุงูุตูุช.';
      statusDiv.classList.remove('hidden');
    }
  }

  // ============================================
  // Backend STT (Record audio + send to server)
  // ============================================
  let backendRecorder = null;

  async function startBackendSTT() {
    if (isListening) return;

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: { sampleRate: 16000, channelCount: 1 }
      });

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = audioContext.createMediaStreamSource(stream);
      const processor = audioContext.createScriptProcessor(4096, 1, 1);
      let chunks = [];

      processor.onaudioprocess = (e) => {
        chunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
      };

      source.connect(processor);
      processor.connect(audioContext.destination);

      backendRecorder = { stream, audioContext, processor, source, chunks };

      isListening = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      startBtn.classList.add('recording');
      statusDiv.classList.remove('hidden');
      statusText.textContent = '๐ด ุฌุงุฑู ุงูุชุณุฌูู โ ' + fieldNames[activeTarget] + ' (ุงุถุบุท ุฅููุงู ูุฅุฑุณุงู)';
      fieldRows[activeTarget]?.classList.add('stt-active-field');

    } catch (err) {
      console.error('Microphone error:', err);
      statusDiv.classList.remove('hidden');
      statusText.textContent = 'โ ุชุนุฐุฑ ุงููุตูู ูููููุฑูููู: ' + err.message;
      setTimeout(() => statusDiv.classList.add('hidden'), 3000);
    }
  }

  async function stopBackendSTT() {
    if (!backendRecorder) return;

    const { stream, audioContext, processor, source, chunks } = backendRecorder;

    processor.disconnect();
    source.disconnect();
    stream.getTracks().forEach(t => t.stop());

    // Merge float32 chunks
    const totalLength = chunks.reduce((acc, c) => acc + c.length, 0);
    const merged = new Float32Array(totalLength);
    let offset = 0;
    for (const chunk of chunks) {
      merged.set(chunk, offset);
      offset += chunk.length;
    }

    const sampleRate = audioContext.sampleRate;
    audioContext.close();
    backendRecorder = null;

    // Encode as WAV
    const wavBlob = encodeWAV(merged, sampleRate);

    // Send to backend
    statusText.textContent = 'โณ ุฌุงุฑู ุงูุชุนุฑู ุนูู ุงูุตูุช...';

    try {
      const formData = new FormData();
      formData.append('audio', wavBlob, 'recording.wav');
      formData.append('language', getLang());

      const res = await fetch('/service/stt/transcribe/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCSRF() },
        body: formData,
      });
      const data = await res.json();

      if (data.success && data.text) {
        const field = getActiveField();
        const current = field.value;
        const sep = current && !current.endsWith(' ') && !current.endsWith('\n') ? ' ' : '';
        field.value = current + sep + data.text;
        field.dispatchEvent(new Event('input', { bubbles: true }));
        statusText.textContent = 'โ ุชู ุงูุชุนุฑู ุนูู ุงููุต ุจูุฌุงุญ';
      } else {
        statusText.textContent = 'โ ' + (data.error || 'ูุดู ุงูุชุนุฑู ุนูู ุงูุตูุช');
      }
    } catch (err) {
      statusText.textContent = 'โ ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู';
      console.error('Backend STT error:', err);
    }

    setTimeout(() => statusDiv.classList.add('hidden'), 3000);
  }

  // WAV encoder
  function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);

    function writeStr(offset, str) {
      for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
    }

    writeStr(0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    writeStr(8, 'WAVE');
    writeStr(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeStr(36, 'data');
    view.setUint32(40, samples.length * 2, true);

    for (let i = 0; i < samples.length; i++) {
      const s = Math.max(-1, Math.min(1, samples[i]));
      view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }

    return new Blob([buffer], { type: 'audio/wav' });
  }

  // ============================================
  // Unified start/stop
  // ============================================
  function startListening() {
    const mode = getSTTMode();
    if (mode === 'backend') {
      startBackendSTT();
    } else {
      startBrowserSTT();
    }
  }

  function stopListening() {
    const wasBrowserListening = recognition && isListening;
    const wasBackendListening = backendRecorder && isListening;

    isListening = false;

    if (recognition) {
      try { recognition.stop(); } catch(e) {}
      recognition = null;
    }

    if (wasBackendListening) {
      stopBackendSTT();
    }

    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.classList.remove('recording');

    if (wasBrowserListening) {
      statusText.textContent = 'โน ุชู ุฅููุงู ุงูุชุณุฌูู';
      setTimeout(() => statusDiv.classList.add('hidden'), 2000);
    }

    Object.values(fieldRows).forEach(row => row?.classList.remove('stt-active-field'));
    document.querySelectorAll('.stt-inline-btn').forEach(b => b.classList.remove('active'));
  }

  // โโโโ Voice commands (browser mode only) โโโโ
  function checkVoiceCommand(text) {
    const normalized = text.replace(/[ูููููููู]/g, '').trim();

    if (/^(ุนููุงู|ุงูุนููุงู|title)/i.test(normalized)) {
      setTarget('title');
      statusText.textContent = '๐ฏ ุชู ุงูุชุจุฏูู ุฅูู: ุงูุนููุงู';
      return true;
    }
    if (/^(ุณุคุงู|ุงูุณุคุงู|ูุต|ุงููุต|question|text)/i.test(normalized)) {
      setTarget('question');
      statusText.textContent = '๐ฏ ุชู ุงูุชุจุฏูู ุฅูู: ูุต ุงูุณุคุงู';
      return true;
    }
    if (/^(ุณุฌู|ุณุฌูู|ุงุจุฏุฃ ุงูุชุณุฌูู|ุงุจุฏุฃ|record|start)/i.test(normalized)) {
      startListening();
      return true;
    }
    if (/^(ุชููู|ุชูููู|ูู|ููู|stop)/i.test(normalized)) {
      stopListening();
      return true;
    }
    if (/^(ุงูุณุญ|ูุณุญ|ุญุฐู|ุงุญุฐู|clear|delete)/i.test(normalized)) {
      const field = getActiveField();
      field.value = '';
      field.dispatchEvent(new Event('input', { bubbles: true }));
      statusText.textContent = '๐ ุชู ูุณุญ ' + fieldNames[activeTarget];
      return true;
    }
    if (/^(ุฃุฑุณู|ุงุฑุณู|ุฅุฑุณุงู|ุงุจุนุซ|send|submit)/i.test(normalized)) {
      stopListening();
      statusText.textContent = '๐ค ุฌุงุฑู ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ...';
      statusDiv.classList.remove('hidden');
      setTimeout(() => form.submit(), 500);
      return true;
    }
    return false;
  }

  // โโโโ Button handlers โโโโ
  startBtn.addEventListener('click', startListening);
  stopBtn.addEventListener('click', stopListening);
  clearBtn.addEventListener('click', () => {
    const field = getActiveField();
    field.value = '';
    field.dispatchEvent(new Event('input', { bubbles: true }));
  });

  // โโโโ Initialize default target โโโโ
  setTarget('question');

  // ============================================
  // Auto-transcribe uploaded audio files
  // ============================================
  const audioInput = document.getElementById('id_question_audio');
  const transcribePanel = document.getElementById('auto-transcribe-panel');
  const transcribeBtn = document.getElementById('auto-transcribe-btn');
  const transcribeStatus = document.getElementById('transcribe-status');

  if (audioInput && transcribePanel && transcribeBtn) {
    audioInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        transcribePanel.classList.remove('hidden');
        transcribeStatus.textContent = '';
      } else {
        transcribePanel.classList.add('hidden');
      }
    });

    transcribeBtn.addEventListener('click', async function() {
      const file = audioInput.files[0];
      if (!file) return;

      this.disabled = true;
      this.textContent = 'โณ ุฌุงุฑู ุงูุชูุฑูุบ...';
      transcribeStatus.textContent = '';

      const formData = new FormData();
      formData.append('audio', file);
      formData.append('language', getLang());

      try {
        const res = await fetch('/service/stt/transcribe/', {
          method: 'POST',
          headers: { 'X-CSRFToken': getCSRF() },
          body: formData,
        });
        const data = await res.json();

        if (data.success && data.text) {
          fields.question.value = data.text;
          fields.question.dispatchEvent(new Event('input', { bubbles: true }));

          if (!fields.title.value.trim()) {
            fields.title.value = data.text.substring(0, 100);
          }

          transcribeStatus.textContent = 'โ ุชู ุงูุชูุฑูุบ ุจูุฌุงุญ';
        } else {
          transcribeStatus.textContent = 'โ ' + (data.error || 'ูุดู ุงูุชูุฑูุบ. ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู ุจุฏูุงู.');
        }
      } catch (err) {
        transcribeStatus.textContent = 'โ ุฎุทุฃ ูู ุงูุงุชุตุงู. ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู ุจุฏูุงู.';
      } finally {
        this.disabled = false;
        this.textContent = '๐ฏ ุชูุฑูุบ ุงูููู ุงูุตูุชู ุชููุงุฆูุงู';
      }
    });
  }
})();
</script>
{% endblock %}
