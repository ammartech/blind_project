{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}ููุตุฉ ุตูุชูุฉ ูุฏุนู ุงูููููููู{% endblock %}</title>

  <!-- IBM Plex (Arabic) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  {% block extra_css %}{% endblock %}
  <script defer src="{% static 'js/tts.js' %}"></script>
  {% block extra_js %}{% endblock %}
</head>
<body>
  <a class="skip-link" href="#main">ุชุฎุทู ุฅูู ุงููุญุชูู</a>

  <header class="site-header">
    <nav class="navbar container">
      <a class="brand" href="{% url 'core:home' %}">
        <span class="brand-dot" aria-hidden="true"></span>
        <span>ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ</span>
      </a>

      <button class="nav-toggle" aria-label="ูุชุญ ุงููุงุฆูุฉ" aria-expanded="false" data-nav-toggle>โฐ</button>

      <ul class="nav-links" data-nav>
        <li><a href="{% url 'core:home' %}">ุงูุฑุฆูุณูุฉ</a></li>
        <li><a href="{% url 'core:services' %}">ุงูุฎุฏูุงุช</a></li>
        <li><a href="{% url 'glossary:list' %}">ูุงููุณ ุงููุตุทูุญุงุช</a></li>
        <li><a href="{% url 'core:about' %}">ูู ูุญู</a></li>
        <li><a href="{% url 'core:contact' %}">ุชูุงุตู</a></li>
        {% if user.is_authenticated %}
          <li><a class="pill" href="{% url 'service:dashboard' %}">ููุญุฉ ุงูุชุญูู</a></li>
          <li>
            <form method="post" action="{% url 'accounts:logout' %}">
              {% csrf_token %}
              <button class="linklike" type="submit">ุฎุฑูุฌ</button>
            </form>
          </li>
        {% else %}
          <li><a class="pill" href="{% url 'accounts:login' %}">ุฏุฎูู</a></li>
          <li><a class="pill outline" href="{% url 'accounts:register' %}">ุชุณุฌูู</a></li>
        {% endif %}
      </ul>
    </nav>
  </header>

  {% if messages %}
    <div class="container">
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Force CSRF cookie to be set on every page (needed for TTS AJAX) -->
  <div style="display:none">{% csrf_token %}</div>

  <main id="main" class="container main">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <div>
        <h3>ูู ูุญู</h3>
        <p>
          ููุตุฉ ุตูุชูุฉ ุฑูููุฉ ูุฏุนู ุฎุฏูุงุช ุงููุนูููุงุช ููููููููู ูู ุงูููุชุจุงุช ุงูุฌุงูุนูุฉ โ ุฏุฑุงุณุฉ ุชุทุจูููุฉ ุนูู ุฌุงูุนุฉ ุทูุจุฉ.
          ูุญูู ุตูุช ุงููุณุชููุฏ ุฅูู ูุตุ ุซู ูุฌูุจ ุฃุฎุตุงุฆู ุงูููุชุจุฉ ูุตููุงุ ููุนูุฏ ุงูุฑุฏ ุจุตูุช ูุงุถุญ ูููุณุชููุฏ.
        </p>
      </div>
      <div>
        <h3>ุฑูุงุจุท ุณุฑูุนุฉ</h3>
        <ul class="footer-links">
          <li><a href="{% url 'core:services' %}">ุงูุฎุฏูุงุช</a></li>
          <li><a href="{% url 'glossary:list' %}">ูุงููุณ ุงููุตุทูุญุงุช</a></li>
          <li><a href="{% url 'core:about' %}">ูู ูุญู</a></li>
          <li><a href="{% url 'core:contact' %}">ุชูุงุตู</a></li>
        </ul>
      </div>
      <div>
        <h3>ุฅุชุงุญุฉ ุงููุตูู</h3>
        <p>ููููู ุชุดุบูู ูุฑุงุกุฉ ุตูุชูุฉ ูุฃู ูุต ูู ุงูุตูุญุฉ ุนุจุฑ ุดุฑูุท ุงูุฅุชุงุญุฉ ุงูุซุงุจุช (๐) ุฃุณูู ุงูุดุงุดุฉ.</p>
      </div>
    </div>
    <div class="container footer-bottom">
      <small>ยฉ {% now "Y" %} ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ โ ุฌููุน ุงูุญููู ูุญููุธุฉ</small>
    </div>
  </footer>

  <!-- Auto-read idle indicator -->
  <div id="autoread-indicator" class="autoread-indicator hidden" role="status" aria-live="polite">
    <span class="autoread-text">๐ ุงููุฑุงุกุฉ ุงูุชููุงุฆูุฉ...</span>
  </div>

  <!-- ===== Global Accessibility TTS Toolbar ===== -->
  <div id="a11y-toolbar" class="a11y-toolbar" role="region" aria-label="ุดุฑูุท ุงููุฑุงุกุฉ ุงูุตูุชูุฉ">
    <button id="a11y-fab" class="a11y-fab" type="button"
            aria-label="ูุชุญ ุฃุฏูุงุช ุงููุฑุงุกุฉ ุงูุตูุชูุฉ"
            title="ุฃุฏูุงุช ุงููุฑุงุกุฉ ุงูุตูุชูุฉ"
            aria-expanded="false">
      ๐
    </button>

    <div id="a11y-panel" class="a11y-panel hidden" role="toolbar" aria-label="ุฃุฏูุงุช ุงููุฑุงุกุฉ">
      <div class="a11y-panel-header">
        <span class="a11y-panel-title">๐ง ุงููุฑุงุกุฉ ุงูุตูุชูุฉ</span>
        <button id="a11y-close" class="a11y-close-btn" type="button" aria-label="ุฅุบูุงู">โ</button>
      </div>

      <!-- Engine toggle -->
      <div class="a11y-panel-row">
        <span class="a11y-label">ุงููุญุฑู:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="ูุญุฑู ุงููุฑุงุกุฉ">
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-engine" value="ai" checked>
            <span>๐ค ุฐูุงุก ุงุตุทูุงุนู</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-engine" value="browser">
            <span>๐ ุงููุชุตูุญ</span>
          </label>
        </div>
      </div>

      <!-- Voice -->
      <div class="a11y-panel-row">
        <span class="a11y-label">ุงูุตูุช:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="ุงุฎุชูุงุฑ ุงูุตูุช">
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-voice" value="female" checked>
            <span>๐ฉ ุฃูุซู</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-voice" value="male">
            <span>๐จ ุฐูุฑ</span>
          </label>
        </div>
      </div>

      <!-- Speed -->
      <div class="a11y-panel-row">
        <span class="a11y-label">ุงูุณุฑุนุฉ:</span>
        <div class="a11y-option-group" role="radiogroup" aria-label="ุณุฑุนุฉ ุงููุฑุงุกุฉ">
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-speed" value="slow">
            <span>๐ข ุจุทูุก</span>
          </label>
          <label class="a11y-voice-option selected">
            <input type="radio" name="a11y-speed" value="normal" checked>
            <span>โถ๏ธ ุนุงุฏู</span>
          </label>
          <label class="a11y-voice-option">
            <input type="radio" name="a11y-speed" value="fast">
            <span>โก ุณุฑูุน</span>
          </label>
        </div>
      </div>

      <div class="a11y-panel-actions">
        <button id="a11y-read-page" class="a11y-action-btn primary" type="button">
          ๐ ูุฑุงุกุฉ ูุญุชูู ุงูุตูุญุฉ
        </button>
        <button id="a11y-stop" class="a11y-action-btn danger" type="button" disabled>
          โน ุฅููุงู
        </button>
      </div>

      <div id="a11y-progress" class="a11y-progress hidden">
        <span id="a11y-status" class="a11y-status"></span>
      </div>
    </div>
  </div>

  <script>
    // Responsive nav toggle
    const btn = document.querySelector('[data-nav-toggle]');
    const nav = document.querySelector('[data-nav]');
    if (btn && nav) {
      btn.addEventListener('click', () => {
        const open = nav.classList.toggle('open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }

    // ===== Accessibility Toolbar =====
    (function() {
      const fab = document.getElementById('a11y-fab');
      const panel = document.getElementById('a11y-panel');
      const readBtn = document.getElementById('a11y-read-page');
      const stopBtn = document.getElementById('a11y-stop');
      const closeBtn = document.getElementById('a11y-close');
      const progress = document.getElementById('a11y-progress');
      const statusEl = document.getElementById('a11y-status');
      if (!fab || !panel) return;

      let toolbarAudio = null;
      let toolbarPlaying = false;

      function getCSRF() {
        for (let c of document.cookie.split(';')) {
          c = c.trim();
          if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
        }
        return '';
      }

      // Toggle panel
      fab.addEventListener('click', () => {
        const opening = panel.classList.contains('hidden');
        panel.classList.toggle('hidden');
        fab.classList.toggle('active', opening);
        fab.setAttribute('aria-expanded', String(opening));
      });
      closeBtn.addEventListener('click', () => {
        panel.classList.add('hidden');
        fab.classList.remove('active');
        fab.setAttribute('aria-expanded', 'false');
      });

      // Highlight sync for all radio groups in panel
      panel.querySelectorAll('.a11y-voice-option input[type="radio"]').forEach(r => {
        r.addEventListener('change', () => {
          const group = r.closest('.a11y-option-group, .a11y-voice-select');
          if (group) {
            group.querySelectorAll('.a11y-voice-option').forEach(l => l.classList.remove('selected'));
          }
          r.closest('.a11y-voice-option')?.classList.add('selected');
        });
      });

      function getVoice() {
        return panel.querySelector('input[name="a11y-voice"]:checked')?.value || 'female';
      }
      function getEngine() {
        return panel.querySelector('input[name="a11y-engine"]:checked')?.value || 'ai';
      }
      function getSpeed() {
        return panel.querySelector('input[name="a11y-speed"]:checked')?.value || 'normal';
      }

      function getPageText() {
        const main = document.getElementById('main');
        if (!main) return '';
        const clone = main.cloneNode(true);
        clone.querySelectorAll('script,style,nav,button,input,select,label,.a11y-toolbar,.breadcrumb,.back-link,.tts-settings,.tts-actions,.tts-controls').forEach(el => el.remove());
        return (clone.textContent || '').replace(/\s+/g, ' ').trim();
      }

      function setStatus(msg, autoHide) {
        if (!statusEl || !progress) return;
        statusEl.textContent = msg;
        progress.classList.remove('hidden');
        if (autoHide) setTimeout(() => progress.classList.add('hidden'), 3500);
      }

      // Read page
      readBtn.addEventListener('click', async () => {
        if (toolbarPlaying) { stopPlayback(); return; }

        const text = getPageText();
        if (!text) { setStatus('ูุง ููุฌุฏ ูุญุชูู ูุตู ูู ุงูุตูุญุฉ', true); return; }

        const truncated = text.substring(0, 2000);
        const voice = getVoice();
        const speed = getSpeed();
        const engine = getEngine();

        // Browser engine path
        if (engine === 'browser') {
          doBrowserTTS(truncated, voice, speed);
          return;
        }

        // AI engine path
        readBtn.disabled = true;
        stopBtn.disabled = false;
        readBtn.innerHTML = 'โณ ุฌุงุฑู ุงูุชุญููู...';
        readBtn.classList.add('loading');

        try {
          const res = await fetch('/service/tts/synthesize/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
            body: JSON.stringify({ text: truncated, voice, speed }),
          });
          const data = await res.json();

          if (data.success && data.audio_url) {
            toolbarAudio = new Audio(data.audio_url);
            const rateMap = { slow: 0.85, normal: 1.0, fast: 1.2 };
            toolbarAudio.playbackRate = rateMap[speed] || 1.0;

            toolbarAudio.onplay = () => {
              toolbarPlaying = true;
              readBtn.innerHTML = 'โธ ุฅููุงู ูุคูุช';
              readBtn.classList.remove('loading');
              readBtn.classList.add('playing');
              readBtn.disabled = false;
              setStatus('โถ ุฌุงุฑู ุงููุฑุงุกุฉ...');
            };
            toolbarAudio.onended = () => { resetUI(); setStatus('โ ุงูุชููุช ุงููุฑุงุกุฉ', true); };
            toolbarAudio.onerror = () => { resetUI(); doBrowserTTS(truncated, voice, speed); };

            await toolbarAudio.play();
          } else {
            throw new Error(data.error || 'ูุดู');
          }
        } catch (err) {
          console.error('A11y TTS:', err);
          resetUI();
          doBrowserTTS(truncated, voice, speed);
        }
      });

      stopBtn.addEventListener('click', stopPlayback);

      function stopPlayback() {
        if (toolbarAudio) { toolbarAudio.pause(); toolbarAudio = null; }
        if ('speechSynthesis' in window) speechSynthesis.cancel();
        if (typeof stopTTS === 'function') stopTTS();
        resetUI();
        setStatus('โน ุชู ุงูุฅููุงู', true);
      }

      function resetUI() {
        toolbarPlaying = false;
        toolbarAudio = null;
        readBtn.innerHTML = '๐ ูุฑุงุกุฉ ูุญุชูู ุงูุตูุญุฉ';
        readBtn.classList.remove('loading', 'playing');
        readBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function doBrowserTTS(text, voice, speed) {
        if (!('speechSynthesis' in window)) {
          setStatus('ุงููุชุตูุญ ูุง ูุฏุนู ุงููุฑุงุกุฉ ุงูุตูุชูุฉ', true);
          return;
        }
        speechSynthesis.cancel();
        setStatus('๐ ุงููุฑุงุกุฉ ุนุจุฑ ูุญุฑู ุงููุชุตูุญ');
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ar';
        const speedMap = { slow: 0.7, normal: 0.9, fast: 1.4 };
        u.rate = speedMap[speed] || 0.9;
        const voices = speechSynthesis.getVoices();
        const arVoice = voices.find(v => v.lang.startsWith('ar'));
        if (arVoice) u.voice = arVoice;
        u.onend = () => { resetUI(); setStatus('โ ุงูุชููุช ุงููุฑุงุกุฉ', true); };
        toolbarPlaying = true;
        readBtn.innerHTML = 'โธ ุฅููุงู ูุคูุช';
        readBtn.classList.add('playing');
        readBtn.disabled = false;
        stopBtn.disabled = false;
        speechSynthesis.speak(u);
      }
    })();

    // ===== Auto-Read on Mouse Idle (20s) =====
    (function() {
      const IDLE_TIMEOUT = 20000; // 20 seconds
      let idleTimer = null;
      let hasAutoRead = false; // Only auto-read once per page load
      let userInteracted = false;

      function resetIdleTimer() {
        if (idleTimer) clearTimeout(idleTimer);
        hasAutoRead = false; // Reset when user moves again
        if (!userInteracted) return;

        idleTimer = setTimeout(() => {
          // Don't auto-read if already playing, or on form pages, or already read
          if (hasAutoRead) return;
          if (typeof isPlaying !== 'undefined' && isPlaying) return;
          if (document.querySelector('.stt-panel, form.form')) return;

          hasAutoRead = true;
          triggerAutoRead();
        }, IDLE_TIMEOUT);
      }

      function triggerAutoRead() {
        // Show a brief notification
        const indicator = document.getElementById('autoread-indicator');
        if (indicator) {
          indicator.classList.remove('hidden');
          indicator.querySelector('.autoread-text').textContent = '๐ ุงููุฑุงุกุฉ ุงูุชููุงุฆูุฉ...';
        }

        // Click the toolbar read button if available
        const readBtn = document.getElementById('a11y-read-page');
        if (readBtn && !readBtn.disabled) {
          // Open the panel first so user can see what's happening
          const panel = document.getElementById('a11y-panel');
          const fab = document.getElementById('a11y-fab');
          if (panel && panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            if (fab) { fab.classList.add('active'); fab.setAttribute('aria-expanded', 'true'); }
          }
          readBtn.click();
        }

        // Hide indicator after a bit
        setTimeout(() => {
          if (indicator) indicator.classList.add('hidden');
        }, 4000);
      }

      // Track mouse/touch/keyboard activity
      ['mousemove', 'mousedown', 'touchstart', 'keydown', 'scroll'].forEach(evt => {
        document.addEventListener(evt, () => {
          userInteracted = true;
          resetIdleTimer();
        }, { passive: true });
      });

      // Start idle tracking after page load
      document.addEventListener('DOMContentLoaded', () => {
        // Don't enable on form-heavy pages (inquiry new, edit, etc.)
        if (document.querySelector('form.form, .stt-panel')) return;
        resetIdleTimer();
      });
    })();
  </script>
</body>
</html>
