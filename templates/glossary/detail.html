{% extends 'base.html' %}
{% block title %}{{ term.term }} | Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª{% endblock %}

{% block content %}
<div class="page-head">
  <nav class="breadcrumb" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
    <a href="{% url 'glossary:list' %}">Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</a>
    <span class="separator">â€º</span>
    <span>{{ term.term }}</span>
  </nav>

  <h1 class="term-title">{{ term.term }}</h1>

  {% if term.pronunciation_hint %}
    <p class="pronunciation-hint">
      <span class="label">ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù†Ø·Ù‚:</span>
      <strong>{{ term.pronunciation_hint }}</strong>
    </p>
  {% endif %}
</div>

<!-- Definition Card -->
<div class="card">
  <h2>Ø§Ù„ØªØ¹Ø±ÙŠÙ</h2>
  <p class="para definition-text">
    {{ term.definition|linebreaksbr }}
  </p>
</div>

<!-- TTS Card -->
<div class="card tts-card">
  <h3>ğŸ”Š Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØªÙŠØ©</h3>

  <!-- Voice selector -->
  <div class="tts-controls">
    <span class="tts-controls-label">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØª:</span>
    <div class="voice-selector" role="radiogroup" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØª">
      <label class="voice-option selected">
        <input type="radio" name="tts-voice" value="female" checked>
        <span>ğŸ‘© Ø£Ù†Ø«Ù‰</span>
      </label>
      <label class="voice-option">
        <input type="radio" name="tts-voice" value="male">
        <span>ğŸ‘¨ Ø°ÙƒØ±</span>
      </label>
    </div>
  </div>

  <!-- TTS Buttons Row -->
  <div class="tts-actions">
    <button class="tts-btn large" id="tts-full-btn"
            type="button"
            data-tts-url="{% url 'service:glossary_tts' term.pk %}"
            aria-label="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙ Ù…Ø¹Ø§Ù‹">
      ğŸ”Š Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙ
    </button>

    <button class="tts-btn" id="tts-term-btn"
            type="button"
            data-tts-url="{% url 'service:glossary_tts' term.pk %}"
            data-tts-mode="term"
            aria-label="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙÙ‚Ø·">
      ğŸ“– Ø§Ù„Ù…ØµØ·Ù„Ø­ ÙÙ‚Ø·
    </button>

    <button class="tts-btn" id="tts-def-btn"
            type="button"
            data-tts-url="{% url 'service:glossary_tts' term.pk %}"
            data-tts-mode="definition"
            aria-label="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø·">
      ğŸ“ Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙÙ‚Ø·
    </button>
  </div>

  <p class="hint">Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØªØ§Ø± (Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰) Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©.</p>
</div>

<!-- Stats Card -->
<div class="card stats-card">
  <div class="term-stats">
    <span>ğŸ‘ï¸ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª: <strong>{{ term.view_count }}</strong></span>
    <span>ğŸ”Š Ù…Ø±Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„: <strong id="tts-play-count">{{ term.tts_play_count }}</strong></span>
    <span>ğŸ“… Ø£Ø¶ÙŠÙ: <strong>{{ term.created_at|date:"Y/m/d" }}</strong></span>
  </div>
</div>

<!-- Actions -->
<div class="back-link">
  <a class="btn outline" href="{% url 'glossary:list' %}">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª</a>
  {% if user.is_authenticated and user.is_librarian %}
    <a class="btn secondary" href="{% url 'service:glossary_edit' term.pk %}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
(function() {
  // ---- CSRF token from cookies ----
  function getCSRF() {
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith('csrftoken=')) return decodeURIComponent(c.substring(10));
    }
    return '';
  }

  // ---- Voice selector UI sync ----
  function syncVoiceUI() {
    document.querySelectorAll('.voice-option').forEach(l => l.classList.remove('selected'));
    const checked = document.querySelector('input[name="tts-voice"]:checked');
    if (checked) checked.closest('.voice-option')?.classList.add('selected');
  }
  document.querySelectorAll('input[name="tts-voice"]').forEach(r =>
    r.addEventListener('change', syncVoiceUI)
  );

  function getVoice() {
    const c = document.querySelector('input[name="tts-voice"]:checked');
    return c ? c.value : 'female';
  }

  // ---- TTS playback state ----
  let audio = null;
  let playing = false;

  function stopAudio() {
    if (audio) { audio.pause(); audio.currentTime = 0; audio = null; }
    if ('speechSynthesis' in window) speechSynthesis.cancel();
    playing = false;
    document.querySelectorAll('.tts-btn').forEach(b => {
      b.classList.remove('loading', 'playing');
      b.disabled = false;
    });
  }

  // ---- Main TTS handler ----
  async function playTTSFromButton(button) {
    if (playing) { stopAudio(); return; }

    const url = button.getAttribute('data-tts-url');
    const mode = button.getAttribute('data-tts-mode') || 'full';
    const voice = getVoice();

    if (!url) return;

    const origHTML = button.innerHTML;
    button.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
    button.disabled = true;
    button.classList.add('loading');

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRF(),
        },
        body: JSON.stringify({ mode: mode, type: mode, voice: voice }),
      });

      const data = await res.json();

      if (!res.ok || !data.success || !data.audio_url) {
        throw new Error(data.error || 'ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª');
      }

      audio = new Audio(data.audio_url);

      audio.onplay = () => {
        playing = true;
        button.innerHTML = 'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù';
        button.classList.remove('loading');
        button.classList.add('playing');
        button.disabled = false;
      };

      audio.onended = () => {
        playing = false;
        audio = null;
        button.innerHTML = origHTML;
        button.classList.remove('playing');
      };

      audio.onerror = () => {
        playing = false;
        button.innerHTML = origHTML;
        button.classList.remove('loading', 'playing');
        button.disabled = false;
        // Fallback to browser speech
        fallbackBrowserTTS(mode, voice);
      };

      await audio.play();

      // Update play count
      if (data.play_count != null) {
        const el = document.getElementById('tts-play-count');
        if (el) el.textContent = data.play_count;
      }

    } catch (err) {
      console.error('TTS Error:', err);
      button.innerHTML = origHTML;
      button.classList.remove('loading', 'playing');
      button.disabled = false;
      // Fallback to browser speech
      fallbackBrowserTTS(mode, voice);
    }
  }

  function fallbackBrowserTTS(mode, voice) {
    if (!('speechSynthesis' in window)) return;
    const term = {{ term.term|escapejs|safe }};
    const def = {{ term.definition|escapejs|safe }};
    let text = term + '. ' + def;
    if (mode === 'term') text = term;
    else if (mode === 'definition') text = def;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'ar';
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
  }

  // ---- Attach click handlers ----
  document.querySelectorAll('[data-tts-url]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      playTTSFromButton(this);
    });
  });
})();
</script>
{% endblock %}
