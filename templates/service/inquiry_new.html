{% extends 'base.html' %}
{% block title %}ุงุณุชูุณุงุฑ ุฌุฏูุฏ | ููุตุฉ ุทูุจุฉ ุงูุตูุชูุฉ{% endblock %}

{% block content %}
<div class="page-head">
  <nav class="breadcrumb" aria-label="ุงูุชููู">
    <a href="{% url 'service:dashboard' %}">ููุญุฉ ุงูุชุญูู</a>
    <span class="separator">โบ</span>
    <span>ุงุณุชูุณุงุฑ ุฌุฏูุฏ</span>
  </nav>
  <h1>ุฅุฑุณุงู ุงุณุชูุณุงุฑ ุฌุฏูุฏ</h1>
  <p class="muted">ููููู ูุชุงุจุฉ ุณุคุงูู ุฃู ุงุณุชุฎุฏุงู ุงูุฅููุงุก ุงูุตูุชู ุฃู ุฑูุน ููู ุตูุชู.</p>
</div>

<div class="card">
  <form method="post" enctype="multipart/form-data" class="form" id="inquiry-form">
    {% csrf_token %}

    {{ form.non_field_errors }}

    <!-- ===== Title Field with inline mic ===== -->
    <div class="form-row" id="field-row-title">
      <div class="field-label-row">
        <label for="{{ form.title.id_for_label }}">ุนููุงู ุงูุงุณุชูุณุงุฑ *</label>
        <button type="button" class="stt-inline-btn" data-stt-target="title" aria-label="ุฅููุงุก ุงูุนููุงู ุตูุชูุงู" title="ุฅููุงุก ุงูุนููุงู ุตูุชูุงู">
          ๐ค
        </button>
      </div>
      {{ form.title }}
      {{ form.title.errors }}
      <p class="field-hint">ุงูุชุจ ุนููุงูุงู ูุฎุชุตุฑุงู ูุตู ุณุคุงูู</p>
    </div>

    <!-- ===== Question Text Field with inline mic ===== -->
    <div class="form-row" id="field-row-question">
      <div class="field-label-row">
        <label for="{{ form.question_text.id_for_label }}">ูุต ุงูุณุคุงู</label>
        <button type="button" class="stt-inline-btn" data-stt-target="question" aria-label="ุฅููุงุก ุงูุณุคุงู ุตูุชูุงู" title="ุฅููุงุก ุงูุณุคุงู ุตูุชูุงู">
          ๐ค
        </button>
      </div>
      {{ form.question_text }}
      {{ form.question_text.errors }}
      <p class="field-hint">ุงูุชุจ ุณุคุงูู ููุงุ ุฃู ุงุณุชุฎุฏู ุงูุฅููุงุก ุงูุตูุชู ุฃุฏูุงูุ ุฃู ุงุฑูุน ููู ุตูุชู</p>
    </div>

    <!-- ===== Voice Recognition (STT) Panel ===== -->
    <div class="stt-panel card" id="stt-panel">
      <h3>๐ค ุงูุฅููุงุก ุงูุตูุชู</h3>
      <p class="hint">ุชุญุฏุซ ูุณูุชู ุชุญููู ููุงูู ุฅูู ูุต ุชููุงุฆูุงู. ุงุฎุชุฑ ุงูุญูู ุงููุณุชูุฏู ุซู ุงุจุฏุฃ ุงูุชุณุฌูู.</p>

      <!-- Target field selector -->
      <div class="tts-setting-group">
        <span class="tts-setting-label">ุงูุญูู ุงููุณุชูุฏู:</span>
        <div class="voice-selector" role="radiogroup" aria-label="ุงูุญูู ุงููุณุชูุฏู ููุฅููุงุก">
          <label class="voice-option stt-target-option" id="stt-target-title">
            <input type="radio" name="stt-target" value="title">
            <span>๐ ุงูุนููุงู</span>
          </label>
          <label class="voice-option stt-target-option selected" id="stt-target-question">
            <input type="radio" name="stt-target" value="question" checked>
            <span>๐ฌ ูุต ุงูุณุคุงู</span>
          </label>
        </div>
      </div>

      <!-- Language selector -->
      <div class="tts-setting-group">
        <span class="tts-setting-label">ุงููุบุฉ:</span>
        <div class="voice-selector" role="radiogroup" aria-label="ูุบุฉ ุงูุฅููุงุก">
          <label class="voice-option selected">
            <input type="radio" name="stt-lang" value="ar-SA" checked>
            <span>๐ธ๐ฆ ุงูุนุฑุจูุฉ</span>
          </label>
          <label class="voice-option">
            <input type="radio" name="stt-lang" value="en-US">
            <span>๐บ๐ธ English</span>
          </label>
        </div>
      </div>

      <!-- STT controls -->
      <div class="stt-controls">
        <button type="button" id="stt-start" class="btn primary stt-btn" aria-label="ุจุฏุก ุงูุชุณุฌูู">
          ๐ค ุงุจุฏุฃ ุงูุชุณุฌูู
        </button>
        <button type="button" id="stt-stop" class="btn danger stt-btn" disabled aria-label="ุฅููุงู ุงูุชุณุฌูู">
          โน ุฅููุงู
        </button>
        <button type="button" id="stt-clear" class="btn outline stt-btn" aria-label="ูุณุญ ุงูุญูู">
          ๐๏ธ ูุณุญ ุงูุญูู
        </button>
      </div>

      <!-- Active target indicator -->
      <div id="stt-target-indicator" class="stt-target-indicator">
        <span class="stt-target-icon">๐ฏ</span>
        <span id="stt-target-label">ุงูุฅููุงุก ูู: <strong>ูุต ุงูุณุคุงู</strong></span>
      </div>

      <!-- Status indicator -->
      <div id="stt-status" class="stt-status hidden" role="status" aria-live="polite">
        <span class="stt-pulse"></span>
        <span id="stt-status-text">ุฌุงูุฒ</span>
      </div>

      <!-- Voice commands hint -->
      <div class="stt-commands-hint">
        <strong>ุงูุฃูุงูุฑ ุงูุตูุชูุฉ:</strong><br>
        <span class="stt-cmd">ยซุนููุงูยป</span> ูููุชุงุจุฉ ูู ุงูุนููุงู &nbsp;
        <span class="stt-cmd">ยซุณุคุงูยป</span> ูููุชุงุจุฉ ูู ูุต ุงูุณุคุงู &nbsp;
        <span class="stt-cmd">ยซุณุฌููยป</span> ูุจุฏุก ุงูุชุณุฌูู &nbsp;
        <span class="stt-cmd">ยซุชููููยป</span> ูุฅููุงู ุงูุชุณุฌูู &nbsp;
        <span class="stt-cmd">ยซุงูุณุญยป</span> ููุณุญ ุงูุญูู &nbsp;
        <span class="stt-cmd">ยซุฃุฑุณูยป</span> ูุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ
      </div>
    </div>

    <div class="form-row">
      <label for="{{ form.question_audio.id_for_label }}">ููู ุตูุชู (ุงุฎุชูุงุฑู)</label>
      <div class="file-upload-wrapper">
        {{ form.question_audio }}
        <p class="field-hint">ุงููููุงุช ุงููุฏุนููุฉ: MP3, WAV, OGG, M4A, WebM (ุงูุญุฏ ุงูุฃูุตู: 10 ููุฌุงุจุงูุช)</p>
      </div>
      {{ form.question_audio.errors }}
    </div>

    <div class="form-row">
      <label for="{{ form.priority.id_for_label }}">ุงูุฃููููุฉ</label>
      {{ form.priority }}
      {{ form.priority.errors }}
    </div>

    <div class="form-actions">
      <button class="btn primary" type="submit" id="submit-btn">ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ</button>
      <a class="btn outline" href="{% url 'service:dashboard' %}">ุฅูุบุงุก</a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    const panel = document.getElementById('stt-panel');
    if (panel) {
      panel.innerHTML = '<p class="hint">โ๏ธ ุงููุชุตูุญ ูุง ูุฏุนู ุงูุชุนุฑู ุนูู ุงูุตูุช. ูุฑุฌู ุงุณุชุฎุฏุงู Chrome ุฃู Edge.</p>';
    }
    document.querySelectorAll('.stt-inline-btn').forEach(b => b.style.display = 'none');
    return;
  }

  // โโโโ DOM refs โโโโ
  const startBtn = document.getElementById('stt-start');
  const stopBtn = document.getElementById('stt-stop');
  const clearBtn = document.getElementById('stt-clear');
  const statusDiv = document.getElementById('stt-status');
  const statusText = document.getElementById('stt-status-text');
  const targetIndicator = document.getElementById('stt-target-indicator');
  const targetLabel = document.getElementById('stt-target-label');
  const submitBtn = document.getElementById('submit-btn');
  const form = document.getElementById('inquiry-form');

  // Field references
  const fields = {
    title: document.getElementById('id_title'),
    question: document.getElementById('id_question_text')
  };
  const fieldRows = {
    title: document.getElementById('field-row-title'),
    question: document.getElementById('field-row-question')
  };
  const fieldNames = {
    title: 'ุงูุนููุงู',
    question: 'ูุต ุงูุณุคุงู'
  };

  let recognition = null;
  let isListening = false;
  let activeTarget = 'question'; // default target

  // โโโโ Target field management โโโโ
  function setTarget(target) {
    if (!fields[target]) return;
    activeTarget = target;

    // Update radio buttons
    document.querySelectorAll('input[name="stt-target"]').forEach(r => {
      r.closest('.stt-target-option')?.classList.remove('selected');
      if (r.value === target) {
        r.checked = true;
        r.closest('.stt-target-option')?.classList.add('selected');
      }
    });

    // Update indicator
    targetLabel.innerHTML = 'ุงูุฅููุงุก ูู: <strong>' + fieldNames[target] + '</strong>';

    // Highlight active field row
    Object.values(fieldRows).forEach(row => row?.classList.remove('stt-active-field'));
    fieldRows[target]?.classList.add('stt-active-field');

    // Focus the field
    fields[target]?.focus();

    if (isListening) {
      statusText.textContent = '๐ด ุฌุงุฑู ุงูุงุณุชูุงุน โ ' + fieldNames[target];
    }
  }

  function getActiveField() {
    return fields[activeTarget] || fields.question;
  }

  // โโโโ Target selector sync โโโโ
  document.querySelectorAll('input[name="stt-target"]').forEach(r => {
    r.addEventListener('change', function() {
      setTarget(this.value);
    });
  });

  // โโโโ Inline mic buttons โโโโ
  document.querySelectorAll('.stt-inline-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const target = this.dataset.sttTarget;
      setTarget(target);
      if (!isListening) {
        startListening();
      }
    });
  });

  // โโโโ Language selector sync โโโโ
  document.querySelectorAll('input[name="stt-lang"]').forEach(r => {
    r.addEventListener('change', function() {
      document.querySelectorAll('[name="stt-lang"]').forEach(radio => {
        radio.closest('.voice-option')?.classList.remove('selected');
      });
      this.closest('.voice-option')?.classList.add('selected');
      if (recognition && isListening) {
        stopListening();
        setTimeout(startListening, 300);
      }
    });
  });

  function getLang() {
    const el = document.querySelector('input[name="stt-lang"]:checked');
    return el ? el.value : 'ar-SA';
  }

  // โโโโ Core STT โโโโ
  function createRecognition() {
    const rec = new SpeechRecognition();
    rec.lang = getLang();
    rec.continuous = true;
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    return rec;
  }

  function startListening() {
    if (isListening) return;

    recognition = createRecognition();

    recognition.onstart = () => {
      isListening = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      startBtn.classList.add('recording');
      statusDiv.classList.remove('hidden');
      statusText.textContent = '๐ด ุฌุงุฑู ุงูุงุณุชูุงุน โ ' + fieldNames[activeTarget];

      // Highlight active field
      fieldRows[activeTarget]?.classList.add('stt-active-field');

      // Highlight inline button
      document.querySelectorAll('.stt-inline-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.sttTarget === activeTarget);
      });
    };

    recognition.onresult = (e) => {
      let interim = '';
      let finalText = '';

      for (let i = e.resultIndex; i < e.results.length; i++) {
        const transcript = e.results[i][0].transcript;
        if (e.results[i].isFinal) {
          finalText += transcript;
        } else {
          interim += transcript;
        }
      }

      if (finalText) {
        const cmd = checkVoiceCommand(finalText.trim());
        if (cmd) return;

        // Append to the active target field
        const field = getActiveField();
        const current = field.value;
        const sep = current && !current.endsWith(' ') && !current.endsWith('\n') ? ' ' : '';
        field.value = current + sep + finalText.trim();
        field.dispatchEvent(new Event('input', { bubbles: true }));
      }

      if (interim) {
        statusText.textContent = '๐ด [' + fieldNames[activeTarget] + '] ' + interim;
      }
    };

    recognition.onerror = (e) => {
      console.error('STT Error:', e.error);
      if (e.error === 'no-speech') {
        statusText.textContent = 'โ๏ธ ูู ูุชู ุฑุตุฏ ููุงู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.';
      } else if (e.error === 'not-allowed') {
        statusText.textContent = 'โ๏ธ ูุฑุฌู ุงูุณูุงุญ ุจุงููุตูู ุฅูู ุงููููุฑูููู.';
      } else {
        statusText.textContent = 'โ๏ธ ุฎุทุฃ: ' + e.error;
      }
      setTimeout(() => { if (!isListening) statusDiv.classList.add('hidden'); }, 3000);
    };

    recognition.onend = () => {
      if (isListening) {
        try { recognition.start(); } catch(e) { stopListening(); }
        return;
      }
      stopListening();
    };

    try {
      recognition.start();
    } catch(e) {
      statusText.textContent = 'โ๏ธ ุชุนุฐุฑ ุจุฏุก ุงูุชุนุฑู ุนูู ุงูุตูุช.';
      statusDiv.classList.remove('hidden');
    }
  }

  function stopListening() {
    isListening = false;
    if (recognition) {
      try { recognition.stop(); } catch(e) {}
      recognition = null;
    }
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startBtn.classList.remove('recording');
    statusText.textContent = 'โน ุชู ุฅููุงู ุงูุชุณุฌูู';
    setTimeout(() => statusDiv.classList.add('hidden'), 2000);

    // Remove field highlights
    Object.values(fieldRows).forEach(row => row?.classList.remove('stt-active-field'));
    document.querySelectorAll('.stt-inline-btn').forEach(b => b.classList.remove('active'));
  }

  // โโโโ Voice commands โโโโ
  function checkVoiceCommand(text) {
    const normalized = text.replace(/[ูููููููู]/g, '').trim();

    // "ุนููุงู" โ switch to title field
    if (/^(ุนููุงู|ุงูุนููุงู|title)/i.test(normalized)) {
      setTarget('title');
      statusText.textContent = '๐ฏ ุชู ุงูุชุจุฏูู ุฅูู: ุงูุนููุงู';
      return true;
    }
    // "ุณุคุงู" / "ูุต" โ switch to question text field
    if (/^(ุณุคุงู|ุงูุณุคุงู|ูุต|ุงููุต|question|text)/i.test(normalized)) {
      setTarget('question');
      statusText.textContent = '๐ฏ ุชู ุงูุชุจุฏูู ุฅูู: ูุต ุงูุณุคุงู';
      return true;
    }
    // "ุณุฌู" โ start recording
    if (/^(ุณุฌู|ุณุฌูู|ุงุจุฏุฃ ุงูุชุณุฌูู|ุงุจุฏุฃ|record|start)/i.test(normalized)) {
      startListening();
      return true;
    }
    // "ุชููู" โ stop recording
    if (/^(ุชููู|ุชูููู|ูู|ููู|stop)/i.test(normalized)) {
      stopListening();
      return true;
    }
    // "ุงูุณุญ" โ clear active field
    if (/^(ุงูุณุญ|ูุณุญ|ุญุฐู|ุงุญุฐู|clear|delete)/i.test(normalized)) {
      const field = getActiveField();
      field.value = '';
      field.dispatchEvent(new Event('input', { bubbles: true }));
      statusText.textContent = '๐๏ธ ุชู ูุณุญ ' + fieldNames[activeTarget];
      return true;
    }
    // "ุฃุฑุณู" โ submit form
    if (/^(ุฃุฑุณู|ุงุฑุณู|ุฅุฑุณุงู|ุงุจุนุซ|send|submit)/i.test(normalized)) {
      stopListening();
      statusText.textContent = '๐ค ุฌุงุฑู ุฅุฑุณุงู ุงูุงุณุชูุณุงุฑ...';
      statusDiv.classList.remove('hidden');
      setTimeout(() => form.submit(), 500);
      return true;
    }
    return false;
  }

  // โโโโ Button handlers โโโโ
  startBtn.addEventListener('click', startListening);
  stopBtn.addEventListener('click', stopListening);
  clearBtn.addEventListener('click', () => {
    const field = getActiveField();
    field.value = '';
    field.dispatchEvent(new Event('input', { bubbles: true }));
  });

  // โโโโ Initialize default target โโโโ
  setTarget('question');

  // โโโโ Always-on command listener โโโโ
  let commandRecognition = null;

  function startCommandListener() {
    if (!SpeechRecognition) return;
    if (commandRecognition) return;

    commandRecognition = new SpeechRecognition();
    commandRecognition.lang = 'ar-SA';
    commandRecognition.continuous = true;
    commandRecognition.interimResults = false;

    commandRecognition.onresult = (e) => {
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) {
          const text = e.results[i][0].transcript.trim();
          if (!isListening) {
            checkVoiceCommand(text);
          }
        }
      }
    };

    commandRecognition.onend = () => {
      if (!isListening && commandRecognition) {
        try { commandRecognition.start(); } catch(e) {}
      }
    };

    commandRecognition.onerror = () => {
      if (!isListening) {
        setTimeout(() => {
          if (commandRecognition) {
            try { commandRecognition.start(); } catch(e) {}
          }
        }, 1000);
      }
    };
  }

  let commandListenerStarted = false;
  document.addEventListener('click', function initCommandListener() {
    if (commandListenerStarted) return;
    commandListenerStarted = true;
    startCommandListener();
    if (commandRecognition && !isListening) {
      try { commandRecognition.start(); } catch(e) {}
    }
  }, { once: false });
})();
</script>
{% endblock %}
